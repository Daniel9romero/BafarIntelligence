<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAFAR Intelligence Hub - Centro de Inteligencia Competitiva</title>
    <style>
        /* Base styles - Reset and typography */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Typography */
        h2 {
            color: #1e3a5f;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c41e3a;
            font-weight: 600;
        }

        h3 {
            color: #2c4158;
            font-size: 1.3em;
            margin: 25px 0 15px 0;
            font-weight: 600;
        }

        /* Layout */
        .content {
            padding: 30px 40px;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Header */
        .header {
            background: #1e3a5f;
            color: white;
            padding: 20px 40px;
            border-bottom: 4px solid #c41e3a;
            position: relative;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo {
            max-height: 60px;
            max-width: 180px;
            width: auto;
            height: auto;
            filter: brightness(1.2) drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
            transition: all 0.3s ease;
        }

        .header-logo:hover {
            filter: brightness(1.4) drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
            transform: scale(1.05);
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Responsive header */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 20px;
            }
            
            .header-logo {
                max-height: 50px;
                max-width: 150px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }

        /* Sync status indicator */
        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sync-local { background: #ffc107; animation: none; }
        .sync-error { background: #dc3545; animation: none; }

        /* Mode indicator */
        .mode-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Navigation */
        .nav {
            background: #2c4158;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: flex-start;
            overflow-x: auto;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav button {
            background: none;
            border: none;
            color: white;
            padding: 14px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .nav button:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav button.active {
            background: #c41e3a;
            font-weight: 600;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            padding: 20px;
            text-align: center;
            transition: box-shadow 0.2s;
            border-radius: 8px;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #1e3a5f;
            margin: 8px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tables */
        .data-container {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: #2c4158;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
        }

        .data-table td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
        }

        .data-table input, 
        .data-table select, 
        .data-table textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
            border-radius: 4px;
        }

        .data-table textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* Buttons */
        .btn {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            margin: 5px;
            border-radius: 4px;
        }

        .btn:hover {
            background: #2c4158;
        }

        .btn-primary {
            background: #c41e3a;
        }

        .btn-primary:hover {
            background: #a01729;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Process Flow */
        .process-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            overflow-x: auto;
            border-radius: 8px;
        }

        .process-step {
            flex: 1;
            text-align: center;
            position: relative;
            min-width: 140px;
        }

        .step-icon {
            width: 70px;
            height: 70px;
            background: #1e3a5f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .step-title {
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .step-time {
            color: #666;
            font-size: 12px;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-left: 4px solid;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .alert-info {
            border-left-color: #1e3a5f;
            background: #e7f3ff;
        }

        .alert-success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .alert-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        /* Sync Panel */
        .sync-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .sync-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Intelligence Needs Grid */
        .needs-grid {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .unit-needs {
            border: 1px solid #e0e0e0;
            background: white;
            overflow: hidden;
            border-radius: 8px;
        }

        .unit-header {
            background: #2c4158;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .unit-body {
            padding: 20px;
        }

        .needs-section {
            margin-bottom: 20px;
        }

        .needs-section h5 {
            color: #1e3a5f;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .needs-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            border-radius: 4px;
        }

        .metric-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            min-height: 40px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 4px;
        }

        /* Research Matrix Styles */
        .unit-research-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .unit-research-header {
            background: #2c4158;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .unit-research-header:hover {
            background: #34495e;
        }

        .unit-research-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
        }

        .unit-info {
            display: flex;
            gap: 30px;
            font-size: 14px;
            opacity: 0.9;
        }

        .unit-research-body {
            padding: 20px;
            background: #fafafa;
        }

        .research-topics-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .research-topics-table th {
            background: #e9ecef;
            color: #2c4158;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .research-topics-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            font-size: 14px;
        }

        .research-topics-table input,
        .research-topics-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .add-topic-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .add-topic-btn:hover {
            background: #218838;
        }

        .remove-topic-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-topic-btn:hover {
            background: #c82333;
        }

        .unit-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c4158;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expanded .expand-icon {
            transform: rotate(180deg);
        }

        .priority-high {
            background: #ffebee;
        }

        .priority-medium {
            background: #fff3e0;
        }

        .priority-low {
            background: #e8f5e9;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 25px;
            position: relative;
        }

        .timeline-date {
            min-width: 120px;
            font-weight: 600;
            color: #c41e3a;
            font-size: 14px;
        }

        .timeline-content {
            flex: 1;
            background: #fafafa;
            padding: 15px;
            border-left: 3px solid #c41e3a;
            margin-left: 20px;
            border-radius: 0 8px 8px 0;
        }

        /* Progress Bar */
        .progress-container {
            background: #e9ecef;
            height: 40px;
            margin: 20px 0;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
        }

        .progress-bar {
            background: #c41e3a;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
            font-size: 14px;
        }

        /* Action buttons container */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 10000;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-size: 14px;
            color: #1e3a5f;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Unit Details Modal */
        .unit-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }
        
        .unit-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }
        
        .unit-modal-header {
            background: linear-gradient(135deg, #1e3a5f, #2c5282);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #c41e3a;
        }
        
        .unit-modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .unit-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .unit-modal-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .unit-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        
        .unit-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        
        .unit-tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .unit-tab-button:hover {
            color: #1e3a5f;
            background: rgba(30, 58, 95, 0.1);
        }
        
        .unit-tab-button.active {
            color: #1e3a5f;
            border-bottom-color: #c41e3a;
            background: rgba(196, 30, 58, 0.1);
        }
        
        .unit-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .unit-tab.active {
            background: white;
            color: #1e3a5f;
            border-bottom: 3px solid #c41e3a;
            font-weight: 600;
        }
        
        .unit-tab:hover:not(.active) {
            background: #e9ecef;
            color: #495057;
        }
        
        .unit-tab-content {
            display: none;
        }
        
        .unit-tab-content.active {
            display: block;
        }
        
        /* Organigrama Styles */
        .orgchart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .org-node {
            background: white;
            border: 2px solid #1e3a5f;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            display: inline-block;
            min-width: 200px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .org-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-color: #c41e3a;
        }
        
        .org-node.director {
            background: linear-gradient(135deg, #1e3a5f, #2c5282);
            color: white;
            border-color: #c41e3a;
        }
        
        .org-node.manager {
            background: linear-gradient(135deg, #c41e3a, #dc3545);
            color: white;
        }
        
        .org-node.coordinator {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .org-node-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .org-node-name {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .org-node-email {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .org-level {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .org-connector {
            width: 2px;
            height: 30px;
            background: #1e3a5f;
            margin: 0 auto;
        }
        
        /* Org Chart Structure */
        .org-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .org-position {
            margin: 10px;
            text-align: center;
        }
        
        .org-card {
            background: white;
            border: 2px solid #1e3a5f;
            border-radius: 8px;
            padding: 15px;
            margin: 5px;
            min-width: 200px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .org-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-color: #c41e3a;
        }
        
        .org-card .org-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
            color: #1e3a5f;
        }
        
        .org-card .org-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .org-card .org-actions {
            display: flex;
            justify-content: center;
            gap: 5px;
        }
        
        .org-children {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-left: 20px;
            position: relative;
        }
        
        .org-children::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            width: 2px;
            height: 20px;
            background: #ccc;
            transform: translateX(-50%);
        }
        
        .level-0 .org-card {
            background: linear-gradient(135deg, #1e3a5f, #2c5282);
            color: white;
            border-color: #1e3a5f;
        }
        
        .level-0 .org-card .org-title {
            color: white;
        }
        
        .level-0 .org-card .org-name {
            color: #e0e8f0;
        }
        
        .level-1 .org-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }
        
        .level-1 .org-card .org-title {
            color: white;
        }
        
        .level-1 .org-card .org-name {
            color: #e8f5e8;
        }
        
        .level-2 .org-card {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-color: #007bff;
        }
        
        .level-2 .org-card .org-title {
            color: white;
        }
        
        .level-2 .org-card .org-name {
            color: #e3f2fd;
        }
        
        .level-3 .org-card {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            border-color: #ffc107;
        }
        
        .level-3 .org-card .org-title {
            color: #212529;
        }
        
        .level-3 .org-card .org-name {
            color: #6c5300;
        }
        
        .btn-small {
            background: #007bff;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin: 0 2px;
        }
        
        .btn-small:hover {
            background: #0056b3;
        }
        
        /* Org Position Form Modal */
        .org-form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .org-form-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        
        .org-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .org-form-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .org-form-close:hover {
            color: #c41e3a;
        }
        
        .org-form-group {
            margin-bottom: 20px;
        }
        
        .org-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e3a5f;
        }
        
        .org-form-group input,
        .org-form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .org-form-group input:focus,
        .org-form-group select:focus {
            outline: none;
            border-color: #c41e3a;
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }
        
        .org-form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        .org-form-actions button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .org-form-actions .btn-primary {
            background: #c41e3a;
            color: white;
        }
        
        .org-form-actions .btn-primary:hover {
            background: #a01729;
        }
        
        .org-form-actions .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .org-form-actions .btn-secondary:hover {
            background: #545b62;
        }
        
        .supervisor-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #28a745;
        }
        
        .supervisor-info h4 {
            margin: 0 0 10px 0;
            color: #28a745;
            font-size: 14px;
        }
        
        .supervisor-option {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .supervisor-option:hover {
            border-color: #c41e3a;
            background: rgba(196, 30, 58, 0.05);
        }
        
        .supervisor-option.selected {
            border-color: #c41e3a;
            background: rgba(196, 30, 58, 0.1);
        }
        
        .supervisor-option h5 {
            margin: 0 0 5px 0;
            color: #1e3a5f;
            font-size: 14px;
        }
        
        .supervisor-option p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }
        
        /* Form Styles in Modal */
        .detail-form-group {
            margin-bottom: 20px;
        }
        
        .detail-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e3a5f;
        }
        
        .detail-form-group input,
        .detail-form-group textarea,
        .detail-form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .detail-form-group input:focus,
        .detail-form-group textarea:focus,
        .detail-form-group select:focus {
            outline: none;
            border-color: #1e3a5f;
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }
        
        .detail-form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .unit-modal-content {
                width: 98%;
                height: 95vh;
                margin: 1% auto;
            }
            
            .unit-tabs {
                flex-direction: column;
            }
        }
        
        /* Clickable row effect */
        .data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .data-table tbody tr:hover {
            background-color: #f0f8ff;
        }
        
        .data-table tbody tr:hover .unit-name {
            color: #1e3a5f;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .unit-info {
                flex-direction: column;
                gap: 10px;
            }

            .timeline-item {
                flex-direction: column;
            }

            .timeline-date {
                min-width: auto;
                margin-bottom: 10px;
            }

            .timeline-content {
                margin-left: 0;
                border-left: none;
                border-top: 3px solid #c41e3a;
                border-radius: 8px;
            }

            .sync-status {
                position: static;
                margin-top: 10px;
                justify-self: flex-start;
            }

            .mode-indicator {
                position: static;
                margin-top: 5px;
            }

            .sync-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <!-- BAFAR Logo -->
            <img src="bafar-logo.png" alt="Grupo BAFAR" class="header-logo" 
                 onerror="this.style.display='none';">
            
            <!-- Header Content -->
            <div class="header-content">
                <h1>BAFAR INTELLIGENCE HUB</h1>
                <p>Centro de Inteligencia Competitiva - Modo Colaborativo</p>
            </div>
            
            <!-- Status Indicators -->
            <div class="sync-status" id="syncStatus">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncText">Inicializando...</span>
            </div>
            <div class="mode-indicator" id="modeIndicator">Modo Local</div>
            <div class="user-indicator" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px;">
                👤 <span id="currentUserName"></span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button onclick="showSection('dashboard', this)" class="active">Dashboard</button>
            <button onclick="showSection('units', this)">Unidades de Negocio</button>
            <button onclick="showSection('needs', this)">Necesidades de Información</button>
            <button onclick="showSection('research', this)">Matriz de Investigación</button>
            <button onclick="showSection('timeline', this)">Cronograma</button>
            <button onclick="showSection('metrics', this)">Métricas</button>
            <button id="adminUserMgmtBtn" onclick="showSection('usermanagement', this)" style="display: none;">⚙️ Usuarios</button>
        </nav>

        <div class="content">
            <!-- DASHBOARD SECTION -->
            <section id="dashboard" class="section active">
                <h2>Dashboard Ejecutivo</h2>
                
                <div class="alert alert-info">
                    <strong>Objetivo del Proyecto:</strong> Implementar en 90 días un sistema de gestión del conocimiento que proporcione inteligencia competitiva personalizada para cada unidad de negocio.
                </div>

                <!-- Sync Panel -->
                <div class="sync-panel">
                    <h4>🔄 Estado de Sincronización</h4>
                    <p><strong>Estado:</strong> <span id="syncStatusText">Conectando...</span></p>
                    <p><strong>Última actualización:</strong> <span id="lastSyncTime">Nunca</span></p>
                    <div class="sync-actions">
                        <button class="btn btn-primary btn-small" onclick="refreshData()" id="refreshBtn">🔄 Actualizar Datos</button>
                        <button class="btn btn-success btn-small" onclick="saveToGitHub()" id="saveGitHubBtn">💾 Sincronizar Cambios</button>
                        <button class="btn btn-secondary btn-small" onclick="openPrivateRepoSetup()" style="font-size: 11px;">🔐 Config Repo</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        💡 Los cambios se guardan automáticamente. Usa "Sincronizar" para compartir con el equipo.
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Días Restantes</div>
                        <div class="stat-number" id="daysRemaining">90</div>
                        <div class="stat-label">
                            Fecha Inicio: 
                            <input type="date" id="startDateInput" onchange="updateStartDate(this.value)" 
                                   style="border: none; background: transparent; color: #666; font-size: 12px; margin-top: 5px; ${!window.bafarHub?.isEditor ? 'pointer-events: none;' : ''}" 
                                   ${!window.bafarHub?.isEditor ? 'disabled' : ''}>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unidades Activas</div>
                        <div class="stat-number" id="unitsCount">0</div>
                        <div class="stat-label">Total Configuradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Progreso Sprint</div>
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Fase: Configuración</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Última Sincronización</div>
                        <div class="stat-number" id="lastSync">Nunca</div>
                        <div class="stat-label">Modo: <span id="currentMode">Local</span></div>
                    </div>
                </div>

                <h3>Flujo de Procesamiento de Inteligencia</h3>
                <div class="process-flow">
                    <div class="process-step">
                        <div class="step-icon">1</div>
                        <div class="step-title">CAPTURA</div>
                        <div class="step-time">30 min/día</div>
                    </div>
                    <div class="process-step">
                        <div class="step-icon">2</div>
                        <div class="step-title">VALIDACIÓN</div>
                        <div class="step-time">15 min/doc</div>
                    </div>
                    <div class="process-step">
                        <div class="step-icon">3</div>
                        <div class="step-title">SÍNTESIS</div>
                        <div class="step-time">15 min/doc</div>
                    </div>
                    <div class="process-step">
                        <div class="step-icon">4</div>
                        <div class="step-title">DISTRIBUCIÓN</div>
                        <div class="step-time">Automática</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="fixDataStructure()">Reparar Estructura de Datos</button>
                    <button class="btn btn-danger" onclick="resetAllData()">Reiniciar Todo</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub</button>
                </div>
            </section>

            <!-- BUSINESS UNITS SECTION -->
            <section id="units" class="section">
                <h2>Configuración de Unidades de Negocio</h2>
                
                <div class="data-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Registro de Unidades y Responsables</h3>
                        <div>
                            <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub</button>
                        </div>
                    </div>

                    <!-- Add Unit Form -->
                    <div id="addUnitForm" style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="newUnitName" placeholder="Nombre de la nueva unidad" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button class="btn" onclick="addUnitFromForm()">+ Agregar Unidad</button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Unidad de Negocio</th>
                                <th width="20%">Responsable</th>
                                <th width="20%">Email</th>
                                <th width="10%">Frecuencia</th>
                                <th width="10%">Estado</th>
                                <th width="10%">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <!-- Units will be added here -->
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px; border-left: 4px solid #2196f3;">
                        <small><strong>💡 Tip:</strong> Haz click en cualquier unidad de negocio para ver y editar detalles completos, incluyendo descripción y organigrama.</small>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                        <small><strong>Nota:</strong> Los cambios se guardan automáticamente en tu navegador. Usa "Cargar Datos Compartidos" para obtener la versión más reciente del administrador.</small>
                    </div>
                </div>
            </section>

            <!-- Unit Details Modal -->
            <div id="unitModal" class="unit-modal">
                <div class="unit-modal-content">
                    <div class="unit-modal-header">
                        <h2>
                            <span id="modalUnitIcon">🏢</span>
                            <span id="modalUnitName">Detalles de Unidad</span>
                        </h2>
                        <button class="unit-modal-close" onclick="closeUnitModal()">&times;</button>
                    </div>
                    
                    <div class="unit-modal-body">
                        <div class="unit-tabs">
                            <button id="generalBtn" class="unit-tab-button active" onclick="switchUnitTab('generalTab')">📋 Información General</button>
                            <button id="organigramaBtn" class="unit-tab-button" onclick="switchUnitTab('organigramaTab')">👥 Organigrama</button>
                            <button id="metricsBtn" class="unit-tab-button" onclick="switchUnitTab('metricsTab')">📊 Métricas</button>
                        </div>
                        
                        <!-- General Tab -->
                        <div id="generalTab" class="unit-tab-content active">
                            <form id="unitDetailsForm">
                                <div class="form-row">
                                    <div class="detail-form-group">
                                        <label for="unitName">Nombre de la Unidad</label>
                                        <input type="text" id="unitName" placeholder="Ej: DPC Carnes Frías">
                                    </div>
                                    <div class="detail-form-group">
                                        <label for="unitCode">Código</label>
                                        <input type="text" id="unitCode" placeholder="Ej: DPC-CF">
                                    </div>
                                </div>
                                
                                <div class="detail-form-group">
                                    <label for="unitDescription">Descripción</label>
                                    <textarea id="unitDescription" placeholder="Describe la función y objetivos de esta unidad de negocio..."></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="detail-form-group">
                                        <label for="unitResponsible">Responsable Principal</label>
                                        <input type="text" id="unitResponsible" placeholder="Nombre del responsable">
                                    </div>
                                    <div class="detail-form-group">
                                        <label for="unitEmail">Email</label>
                                        <input type="email" id="unitEmail" placeholder="email@grupobafar.com">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="detail-form-group">
                                        <label for="unitFrequency">Frecuencia de Reportes</label>
                                        <select id="unitFrequency">
                                            <option value="Diaria">Diaria</option>
                                            <option value="Semanal">Semanal</option>
                                            <option value="Quincenal">Quincenal</option>
                                            <option value="Mensual">Mensual</option>
                                        </select>
                                    </div>
                                    <div class="detail-form-group">
                                        <label for="unitStatus">Estado</label>
                                        <select id="unitStatus">
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="En Proceso">En Proceso</option>
                                            <option value="Activo">Activo</option>
                                            <option value="Inactivo">Inactivo</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="detail-form-group">
                                        <label for="unitLocation">Ubicación</label>
                                        <input type="text" id="unitLocation" placeholder="Ej: Oficinas Corporativas, Planta Hermosillo">
                                    </div>
                                    <div class="detail-form-group">
                                        <label for="unitBudget">Presupuesto Anual</label>
                                        <input type="text" id="unitBudget" placeholder="Ej: $2,500,000 MXN">
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Organigrama Tab -->
                        <div id="organigramaTab" class="unit-tab-content">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                                <h3>Estructura Organizacional</h3>
                                <button class="btn btn-primary" onclick="addOrgPosition()">+ Agregar Posición</button>
                            </div>
                            
                            <div class="orgchart-container" id="orgChartContainer">
                                <!-- Organigrama se genera dinámicamente -->
                            </div>
                        </div>
                        
                        <!-- Metrics Tab -->
                        <div id="metricsTab" class="unit-tab-content">
                            <h3>Métricas de la Unidad</h3>
                            <div class="form-row">
                                <div class="detail-form-group">
                                    <label for="unitEmployees">Número de Empleados</label>
                                    <input type="number" id="unitEmployees" placeholder="0">
                                </div>
                                <div class="detail-form-group">
                                    <label for="unitRevenue">Ingresos Anuales</label>
                                    <input type="text" id="unitRevenue" placeholder="$0 MXN">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="detail-form-group">
                                    <label for="unitGoals">Objetivos Anuales</label>
                                    <textarea id="unitGoals" placeholder="Lista los objetivos principales para este año..."></textarea>
                                </div>
                                <div class="detail-form-group">
                                    <label for="unitKPIs">KPIs Principales</label>
                                    <textarea id="unitKPIs" placeholder="Lista los KPIs que se monitorean..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Save Button -->
                        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                            <button class="btn btn-primary" onclick="saveUnitDetails()" style="padding: 12px 30px; font-size: 16px;">
                                💾 Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Org Position Form Modal -->
            <div id="orgFormModal" class="org-form-modal">
                <div class="org-form-content">
                    <div class="org-form-header">
                        <h3 id="orgFormTitle">➕ Agregar Nueva Posición</h3>
                        <button class="org-form-close" onclick="closeOrgForm()">&times;</button>
                    </div>
                    
                    <form id="orgPositionForm">
                        <div class="org-form-group">
                            <label for="orgPositionTitle">🏷️ Título del Puesto *</label>
                            <input type="text" id="orgPositionTitle" placeholder="Ej: Director General, Gerente de Ventas, Coordinador..." required>
                        </div>
                        
                        <div class="org-form-group">
                            <label for="orgPositionName">👤 Nombre de la Persona</label>
                            <input type="text" id="orgPositionName" placeholder="Nombre completo (opcional)">
                        </div>
                        
                        <div class="org-form-group">
                            <label for="orgPositionEmail">📧 Email</label>
                            <input type="email" id="orgPositionEmail" placeholder="correo@grupobafar.com (opcional)">
                        </div>
                        
                        <div id="supervisorSelection" class="org-form-group">
                            <label>👨‍💼 ¿A quién reporta esta posición?</label>
                            <div class="supervisor-info">
                                <h4>Selecciona el supervisor directo:</h4>
                                <div id="supervisorOptions">
                                    <!-- Supervisor options will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="org-form-actions">
                            <button type="button" class="btn-secondary" onclick="closeOrgForm()">Cancelar</button>
                            <button type="submit" class="btn-primary">💾 Guardar Posición</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- INTELLIGENCE NEEDS SECTION -->
            <section id="needs" class="section">
                <h2>Necesidades de Información por Unidad</h2>
                
                <div class="alert alert-info">
                    Configure las necesidades específicas de información para cada unidad de negocio. Los cambios se guardan automáticamente en su equipo.
                </div>

                <div id="needsContainer" class="needs-grid">
                    <!-- Needs forms will be added here -->
                </div>
                
                <div id="emptyNeedsMessage" style="display: none; padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                    <p style="color: #6c757d; font-size: 16px;">No hay unidades de negocio configuradas.</p>
                    <p style="color: #6c757d;">Agregue unidades en la pestaña "Unidades de Negocio" para configurar sus necesidades de información.</p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="exportData('needs')">Exportar Necesidades</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub Necesidades</button>
                </div>
            </section>

            <!-- RESEARCH MATRIX SECTION -->
            <section id="research" class="section">
                <h2>Matriz de Investigación</h2>
                
                <div class="alert alert-info">
                    Configure los tópicos de investigación específicos para cada unidad de negocio, asigne responsables y establezca frecuencias de actualización.
                </div>

                <div id="researchMatrixContainer">
                    <!-- Research matrix cards will be populated here -->
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="generateResearchReport()">Generar Reporte</button>
                    <button class="btn btn-secondary" onclick="exportData('research')">Exportar Matriz</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub Matriz de Investigación</button>
                </div>
            </section>

            <!-- TIMELINE SECTION -->
            <section id="timeline" class="section">
                <h2>Cronograma de Implementación - 90 Días</h2>
                
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 1-2</div>
                        <div class="timeline-content">
                            <strong>FASE 1: DESCUBRIMIENTO</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Entrevistas con ejecutivos</li>
                                <li>Mapeo de necesidades</li>
                                <li>Configuración de herramientas</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 85%; font-size: 12px;">85% Completado</div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 3-8</div>
                        <div class="timeline-content">
                            <strong>FASE 2: INVESTIGACIÓN INTENSIVA</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Producción de 30-40 documentos</li>
                                <li>Creación de biblioteca digital</li>
                                <li>Desarrollo de dashboards</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 25%; font-size: 12px;">25% En Progreso</div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 9-10</div>
                        <div class="timeline-content">
                            <strong>FASE 3: PLATAFORMA DIGITAL</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Implementación de blog interno</li>
                                <li>Migración de contenido</li>
                                <li>Sistema de distribución</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 5%; font-size: 12px;">5% Planeado</div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 11-12</div>
                        <div class="timeline-content">
                            <strong>FASE 4: LANZAMIENTO</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Campaña de comunicación</li>
                                <li>Capacitación de usuarios</li>
                                <li>Medición y ajustes</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 0%; font-size: 12px;">0% Pendiente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="exportData('timeline')">Exportar Cronograma</button>
                    <button class="btn btn-primary" onclick="updateTimelineProgress()">Actualizar Progreso</button>
                </div>
            </section>

            <!-- METRICS SECTION -->
            <section id="metrics" class="section">
                <h2>Métricas de Éxito</h2>
                
                <h3>KPIs de Impacto del Negocio</h3>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Decisiones Informadas</div>
                        <input type="number" id="metricDecisions" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: 10 por mes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Oportunidades ($MXN)</div>
                        <input type="text" id="metricOpportunities" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: $1M MXN</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Riesgos Mitigados</div>
                        <input type="number" id="metricRisks" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: 5 críticos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tiempo Ahorrado (hrs)</div>
                        <input type="number" id="metricTime" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: 100 hrs/mes</div>
                    </div>
                </div>

                <h3>Análisis de Rendimiento</h3>
                <div class="data-container">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h4>Resumen del Mes</h4>
                            <div id="monthlyMetrics">
                                <!-- Monthly metrics will be calculated here -->
                            </div>
                        </div>
                        <div>
                            <h4>Comparación con Objetivos</h4>
                            <div id="goalComparison">
                                <!-- Goal comparison will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="generateMetricsReport()">Generar Reporte de Métricas</button>
                    <button class="btn btn-secondary" onclick="exportData('metrics')">Exportar Datos</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub Métricas</button>
                </div>
            </section>

            <!-- USER MANAGEMENT SECTION (Admin Only) -->
            <section id="usermanagement" class="section">
                <h2>👥 Gestión de Usuarios</h2>
                
                <div class="alert alert-info">
                    <strong>🔐 Área de Administración:</strong> Solo usuarios administradores pueden gestionar usuarios del sistema.
                </div>
                
                <!-- Add User Form -->
                <div class="data-container">
                    <h3>➕ Agregar Nuevo Usuario</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <div class="form-row">
                            <div class="detail-form-group">
                                <label for="newUserUsername">Nombre de Usuario</label>
                                <input type="text" id="newUserUsername" placeholder="ej: carlos.rodriguez">
                            </div>
                            <div class="detail-form-group">
                                <label for="newUserFullName">Nombre Completo</label>
                                <input type="text" id="newUserFullName" placeholder="ej: Carlos Rodríguez">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="detail-form-group">
                                <label for="newUserPassword">Contraseña</label>
                                <input type="password" id="newUserPassword" placeholder="Contraseña inicial">
                            </div>
                            <div class="detail-form-group">
                                <label for="newUserRole">Rol</label>
                                <select id="newUserRole">
                                    <option value="editor">Administrador (Lectura y Escritura)</option>
                                    <option value="viewer">Solo Lectura</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addNewUser()">💾 Agregar Usuario</button>
                    </div>
                    
                    <!-- Users List -->
                    <h3>📋 Usuarios Existentes</h3>
                    <div id="systemUsersList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Users will be listed here -->
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255, 165, 0, 0.1); border-radius: 5px; border: 1px solid #ffa500;">
                        <p style="color: #ffa500; margin: 0; font-size: 14px;">
                            ⚠️ <strong>Nota:</strong> Los cambios en usuarios se guardan localmente. Para sincronizar entre equipos, exporta/importa la configuración.
                        </p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        Datos guardados correctamente
    </div>

    <script src="bafar-intelligence-hub.js"></script>
    <script src="sharepoint-connector.js"></script>
    <script src="config-private.js"></script>
    <script src="github-auto-sync.js"></script>
    <script>
        // Global data structure
        let appData = {
            units: [],
            needs: {},
            research: {},
            metrics: {},
            startDate: new Date().toISOString().split('T')[0],
            progress: 5
        };

        // Initialize the application
        function initApp() {
            // Ensure bafarHub is loaded
            if (!window.bafarHub) {
                console.error('BafarIntelligenceHub not loaded - retrying in 1 second');
                setTimeout(initApp, 1000);
                return;
            }
            
            // Check user session first
            if (!window.bafarHub.checkUserSession()) {
                window.location.href = 'index.html';
                return;
            }

            // Initialize current user from login session
            initializeCurrentUser();
            
            // Initialize user indicator
            document.getElementById('currentUserName').textContent = currentUser;

            // Initialize sync status
            document.getElementById('syncStatusText').textContent = 'Inicializando sistema...';

            // First load local data if available
            const hasLocalData = loadFromLocal();
            
            // Then try to sync with GitHub (but respect local newer data)
            window.bafarHub.loadFromGitHub().then(success => {
                console.log('GitHub load result:', success);
                if (success) {
                    appData = window.bafarHub.appData;
                    const now = new Date();
                    window.bafarHub.lastSync = now;
                    
                    document.getElementById('syncStatusText').textContent = '✅ Conectado a GitHub - Datos actualizados';
                    document.getElementById('lastSyncTime').textContent = now.toLocaleTimeString();
                } else {
                    console.log('GitHub failed, using local data');
                    document.getElementById('syncStatusText').textContent = '⚠️ Modo Local - Sin conexión a GitHub';
                    document.getElementById('lastSyncTime').textContent = 'Local';
                }
                updateUI();
                
                // Start auto-sync every 30 seconds to detect changes from other users
                startAutoRefresh();
            }).catch(error => {
                console.error('Error connecting to GitHub:', error);
                document.getElementById('syncStatusText').textContent = '💾 Usando datos locales guardados';
                document.getElementById('lastSyncTime').textContent = 'Local';
                updateUI();
            });
        }

        // Load from local storage
        function loadFromLocal() {
            const saved = localStorage.getItem('bafarHub');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    window.bafarHub.appData = appData;
                    console.log('Local data loaded successfully');
                    return true;
                } catch (e) {
                    console.error('Error loading local data:', e);
                    initDefaultData();
                    return false;
                }
            } else {
                console.log('No local data found, using defaults');
                initDefaultData();
                return false;
            }
        }

        // Initialize with default data
        function initDefaultData() {
            appData = {
                units: [
                    { id: 1, name: 'DPC Carnes Frías', responsible: '', email: '', frequency: 'Semanal', status: 'Pendiente' },
                    { id: 2, name: 'Food Service', responsible: '', email: '', frequency: 'Diaria', status: 'Pendiente' },
                    { id: 3, name: 'Retail', responsible: '', email: '', frequency: 'Semanal', status: 'Pendiente' },
                    { id: 4, name: 'Exportación', responsible: '', email: '', frequency: 'Diaria', status: 'Pendiente' },
                    { id: 5, name: 'Agroindustrial', responsible: '', email: '', frequency: 'Semanal', status: 'Pendiente' }
                ],
                needs: {},
                research: {},
                metrics: {
                    decisions: 0,
                    opportunities: 0,
                    risks: 0,
                    time: 0
                },
                startDate: new Date().toISOString().split('T')[0],
                progress: 5
            };
            
            // Initialize needs and research for each unit
            appData.units.forEach(unit => {
                appData.needs[unit.id] = {
                    critical: '',
                    competitors: '',
                    regulations: '',
                    market: '',
                    technology: ''
                };
                
                appData.research[unit.id] = {
                    topics: []
                };
            });
            
            window.bafarHub.appData = appData;
        }

        // Update all UI elements
        function updateUI() {
            updateDashboard();
            updateUnitsTable();
            updateNeedsSection();
            updateResearchMatrix();
            updateMetrics();
            makeUnitsClickable();
        }

        // Update dashboard
        function updateDashboard() {
            const start = new Date(appData.startDate);
            const today = new Date();
            const diff = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            const remaining = Math.max(0, 90 - diff);
            
            const daysEl = document.getElementById('daysRemaining');
            const startDateInputEl = document.getElementById('startDateInput');
            const unitsCountEl = document.getElementById('unitsCount');
            const progressEl = document.getElementById('progressPercent');
            const lastSyncEl = document.getElementById('lastSync');
            const currentModeEl = document.getElementById('currentMode');
            
            if (daysEl) daysEl.textContent = remaining;
            if (startDateInputEl) {
                startDateInputEl.value = appData.startDate;
                startDateInputEl.disabled = !window.bafarHub?.isEditor;
            }
            
            const totalUnits = appData.units.length;
            const activeUnits = appData.units.filter(u => u.responsible && u.responsible.trim() !== '').length;
            if (unitsCountEl) unitsCountEl.textContent = `${activeUnits}/${totalUnits}`;
            
            if (progressEl) progressEl.textContent = appData.progress + '%';
            
            // Update last sync time in multiple places
            const timeAgo = window.bafarHub?.lastSync ? window.bafarHub.getTimeAgo(window.bafarHub.lastSync) : 'Nunca';
            if (lastSyncEl) lastSyncEl.textContent = timeAgo;
            
            const lastSyncTimeEl = document.getElementById('lastSyncTime');
            if (lastSyncTimeEl && window.bafarHub?.lastSync) {
                lastSyncTimeEl.textContent = window.bafarHub.lastSync.toLocaleTimeString();
            }
            
            if (currentModeEl) currentModeEl.textContent = window.bafarHub?.isEditor ? 'Editor' : 'Lectura';
        }

        // Update start date
        function updateStartDate(newDate) {
            if (!window.bafarHub?.isEditor) return;
            
            appData.startDate = newDate;
            updateDashboard(); // Recalculate days remaining
            saveAllData();
            window.bafarHub.showNotification('Fecha de inicio actualizada', 'success');
        }

        // Update units table
        function updateUnitsTable() {
            const tbody = document.getElementById('unitsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.units.forEach((unit, index) => {
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" value="${unit.name}" onchange="updateUnitField(${index}, 'name', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td><input type="text" value="${unit.responsible || ''}" placeholder="Nombre" onchange="updateUnitField(${index}, 'responsible', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td><input type="email" value="${unit.email || ''}" placeholder="correo@bafar.com" onchange="updateUnitField(${index}, 'email', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td>
                        <select onchange="updateUnitField(${index}, 'frequency', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Diaria" ${unit.frequency === 'Diaria' ? 'selected' : ''}>Diaria</option>
                            <option value="Semanal" ${unit.frequency === 'Semanal' ? 'selected' : ''}>Semanal</option>
                            <option value="Quincenal" ${unit.frequency === 'Quincenal' ? 'selected' : ''}>Quincenal</option>
                            <option value="Mensual" ${unit.frequency === 'Mensual' ? 'selected' : ''}>Mensual</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateUnitField(${index}, 'status', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Pendiente" ${unit.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="En Proceso" ${unit.status === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="Activo" ${unit.status === 'Activo' ? 'selected' : ''}>Activo</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="removeUnit(${index})" ${!window.bafarHub.isEditor ? 'disabled' : ''}>Eliminar</button>
                    </td>
                `;
            });
        }

        // Update needs section
        function updateNeedsSection() {
            const container = document.getElementById('needsContainer');
            const emptyMessage = document.getElementById('emptyNeedsMessage');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appData.units.length === 0) {
                if (emptyMessage) emptyMessage.style.display = 'block';
                container.style.display = 'none';
                return;
            } else {
                if (emptyMessage) emptyMessage.style.display = 'none';
                container.style.display = 'grid';
            }
            
            appData.units.forEach(unit => {
                if (!appData.needs[unit.id]) {
                    appData.needs[unit.id] = {
                        critical: '',
                        competitors: '',
                        regulations: '',
                        market: '',
                        technology: ''
                    };
                }
                
                const needs = appData.needs[unit.id];
                const disabled = !window.bafarHub.isEditor;
                
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit-needs';
                unitDiv.innerHTML = `
                    <div class="unit-header">${unit.name}</div>
                    <div class="unit-body">
                        <div class="needs-section">
                            <h5>Información Crítica del Negocio</h5>
                            <textarea class="needs-input" placeholder="¿Qué información es vital para la operación diaria?" 
                                onchange="updateNeedField(${unit.id}, 'critical', this.value)" ${disabled ? 'disabled' : ''}>${needs.critical || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Monitoreo de Competencia</h5>
                            <textarea class="needs-input" placeholder="¿Qué necesitas saber sobre la competencia?" 
                                onchange="updateNeedField(${unit.id}, 'competitors', this.value)" ${disabled ? 'disabled' : ''}>${needs.competitors || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Regulaciones y Normatividad</h5>
                            <textarea class="needs-input" placeholder="¿Qué cambios regulatorios debes monitorear?" 
                                onchange="updateNeedField(${unit.id}, 'regulations', this.value)" ${disabled ? 'disabled' : ''}>${needs.regulations || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Tendencias de Mercado</h5>
                            <textarea class="needs-input" placeholder="¿Qué tendencias del mercado impactan tu negocio?" 
                                onchange="updateNeedField(${unit.id}, 'market', this.value)" ${disabled ? 'disabled' : ''}>${needs.market || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Innovación y Tecnología</h5>
                            <textarea class="needs-input" placeholder="¿Qué avances tecnológicos debes seguir?" 
                                onchange="updateNeedField(${unit.id}, 'technology', this.value)" ${disabled ? 'disabled' : ''}>${needs.technology || ''}</textarea>
                        </div>
                    </div>
                `;
                container.appendChild(unitDiv);
            });
        }

        // Update research matrix
        function updateResearchMatrix() {
            const container = document.getElementById('researchMatrixContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!appData.research) {
                appData.research = {};
            }
            
            if (appData.units.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #6c757d; font-size: 16px;">No hay unidades de negocio configuradas.</p>
                        <p style="color: #6c757d;">Agregue unidades en la pestaña "Unidades de Negocio".</p>
                    </div>
                `;
                return;
            }
            
            appData.units.forEach(unit => {
                if (!appData.research[unit.id]) {
                    appData.research[unit.id] = { topics: [] };
                }
                
                const research = appData.research[unit.id];
                const topicsCount = research.topics.length;
                
                const unitCard = document.createElement('div');
                unitCard.className = 'unit-research-card';
                unitCard.innerHTML = `
                    <div class="unit-research-header">
                        <h3>${unit.name}</h3>
                        <div class="unit-info">
                            <span>Responsable: ${unit.responsible || 'No asignado'}</span>
                            <span>Tópicos: ${topicsCount}</span>
                            <span>Estado: ${unit.status}</span>
                        </div>
                    </div>
                    <div class="unit-research-body">
                        <div class="unit-summary">
                            <div class="summary-item">
                                <div class="summary-label">Total Tópicos</div>
                                <div class="summary-value">${topicsCount}</div>
                            </div>
                        </div>
                        
                        <h4>Tópicos de Investigación</h4>
                        <table class="research-topics-table">
                            <thead>
                                <tr>
                                    <th>Tópico</th>
                                    <th>Frecuencia</th>
                                    <th>Próxima Fecha</th>
                                    <th>Responsable</th>
                                    <th>Prioridad</th>
                                    ${window.bafarHub.isEditor ? '<th>Acciones</th>' : ''}
                                </tr>
                            </thead>
                            <tbody id="topics-table-${unit.id}">
                                ${generateTopicsRows(unit.id, research.topics)}
                            </tbody>
                        </table>
                        ${window.bafarHub.isEditor ? `<button class="add-topic-btn" onclick="addResearchTopic(${unit.id})">+ Agregar Tópico</button>` : ''}
                    </div>
                `;
                container.appendChild(unitCard);
            });
        }

        // Generate topic rows for research matrix
        function generateTopicsRows(unitId, topics) {
            if (!topics || topics.length === 0) {
                return '<tr><td colspan="6" style="text-align: center; color: #6c757d;">No hay tópicos configurados</td></tr>';
            }
            
            return topics.map((topic, index) => `
                <tr>
                    <td><input type="text" value="${topic.topic || ''}" onchange="updateResearchTopic(${unitId}, ${index}, 'topic', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td>
                        <select onchange="updateResearchTopic(${unitId}, ${index}, 'frequency', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Diaria" ${topic.frequency === 'Diaria' ? 'selected' : ''}>Diaria</option>
                            <option value="Semanal" ${topic.frequency === 'Semanal' ? 'selected' : ''}>Semanal</option>
                            <option value="Quincenal" ${topic.frequency === 'Quincenal' ? 'selected' : ''}>Quincenal</option>
                            <option value="Mensual" ${topic.frequency === 'Mensual' ? 'selected' : ''}>Mensual</option>
                            <option value="Trimestral" ${topic.frequency === 'Trimestral' ? 'selected' : ''}>Trimestral</option>
                        </select>
                    </td>
                    <td><input type="date" value="${topic.nextDate || ''}" onchange="updateResearchTopic(${unitId}, ${index}, 'nextDate', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td><input type="text" value="${topic.responsible || ''}" onchange="updateResearchTopic(${unitId}, ${index}, 'responsible', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td>
                        <select onchange="updateResearchTopic(${unitId}, ${index}, 'priority', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Alta" ${topic.priority === 'Alta' ? 'selected' : ''}>Alta</option>
                            <option value="Media" ${topic.priority === 'Media' ? 'selected' : ''}>Media</option>
                            <option value="Baja" ${topic.priority === 'Baja' ? 'selected' : ''}>Baja</option>
                        </select>
                    </td>
                    ${window.bafarHub.isEditor ? `<td><button class="remove-topic-btn" onclick="removeResearchTopic(${unitId}, ${index})">Eliminar</button></td>` : ''}
                </tr>
            `).join('');
        }

        // Update metrics
        function updateMetrics() {
            const decisionsEl = document.getElementById('metricDecisions');
            const opportunitiesEl = document.getElementById('metricOpportunities');
            const risksEl = document.getElementById('metricRisks');
            const timeEl = document.getElementById('metricTime');
            
            if (decisionsEl) {
                decisionsEl.value = appData.metrics.decisions || 0;
                decisionsEl.disabled = !window.bafarHub.isEditor;
            }
            if (opportunitiesEl) {
                opportunitiesEl.value = appData.metrics.opportunities || 0;
                opportunitiesEl.disabled = !window.bafarHub.isEditor;
            }
            if (risksEl) {
                risksEl.value = appData.metrics.risks || 0;
                risksEl.disabled = !window.bafarHub.isEditor;
            }
            if (timeEl) {
                timeEl.value = appData.metrics.time || 0;
                timeEl.disabled = !window.bafarHub.isEditor;
            }
        }

        // Event handlers
        function updateUnitField(index, field, value) {
            if (appData.units[index]) {
                appData.units[index][field] = value;
                if (field === 'name') {
                    updateNeedsSection();
                    updateResearchMatrix();
                }
                if (field === 'responsible') {
                    updateDashboard();
                    updateResearchMatrix();
                }
                saveAllData();
            }
        }

        function updateNeedField(unitId, field, value) {
            if (!appData.needs[unitId]) {
                appData.needs[unitId] = {};
            }
            appData.needs[unitId][field] = value;
            saveAllData();
        }

        function addUnitFromForm() {
            if (!window.bafarHub.isEditor) return;
            
            const input = document.getElementById('newUnitName');
            const name = input ? input.value.trim() : '';
            
            if (!name) {
                window.bafarHub.showNotification('Por favor ingrese un nombre para la unidad', 'warning');
                return;
            }
            
            let newId = 1;
            if (appData.units.length > 0) {
                const maxId = Math.max(...appData.units.map(u => u.id || 0));
                newId = maxId + 1;
            }
            
            const newUnit = {
                id: newId,
                name: name,
                responsible: '',
                email: '',
                frequency: 'Semanal',
                status: 'Pendiente'
            };
            
            appData.units.push(newUnit);
            
            appData.needs[newId] = {
                critical: '',
                competitors: '',
                regulations: '',
                market: '',
                technology: ''
            };
            
            appData.research[newId] = {
                topics: []
            };
            
            input.value = '';
            updateUI();
            saveAllData();
            
            window.bafarHub.showNotification('Unidad agregada: ' + name, 'success');
        }

        function removeUnit(index) {
            if (!window.bafarHub.isEditor) return;
            if (!appData.units[index]) return;
            
            const unitName = appData.units[index].name;
            
            if (confirm('¿Está seguro de eliminar esta unidad: ' + unitName + '?')) {
                const unitId = appData.units[index].id;
                
                appData.units.splice(index, 1);
                
                if (appData.needs[unitId]) {
                    delete appData.needs[unitId];
                }
                
                if (appData.research[unitId]) {
                    delete appData.research[unitId];
                }
                
                updateUI();
                saveAllData();
                
                window.bafarHub.showNotification('Unidad eliminada: ' + unitName, 'success');
            }
        }

        function addResearchTopic(unitId) {
            if (!window.bafarHub.isEditor) return;
            
            if (!appData.research[unitId]) {
                appData.research[unitId] = { topics: [] };
            }
            
            const newTopic = {
                topic: '',
                frequency: 'Semanal',
                nextDate: '',
                responsible: '',
                priority: 'Media'
            };
            
            appData.research[unitId].topics.push(newTopic);
            updateResearchMatrix();
            saveAllData();
        }

        function updateResearchTopic(unitId, topicIndex, field, value) {
            if (appData.research[unitId] && appData.research[unitId].topics[topicIndex]) {
                appData.research[unitId].topics[topicIndex][field] = value;
                saveAllData();
            }
        }

        function removeResearchTopic(unitId, topicIndex) {
            if (!window.bafarHub.isEditor) return;
            
            if (confirm('¿Eliminar este tópico de investigación?')) {
                if (appData.research[unitId] && appData.research[unitId].topics) {
                    appData.research[unitId].topics.splice(topicIndex, 1);
                    updateResearchMatrix();
                    saveAllData();
                }
            }
        }

        function saveAllData() {
            // Update metrics from inputs
            const decisionsEl = document.getElementById('metricDecisions');
            const opportunitiesEl = document.getElementById('metricOpportunities');
            const risksEl = document.getElementById('metricRisks');
            const timeEl = document.getElementById('metricTime');
            
            if (decisionsEl) appData.metrics.decisions = parseInt(decisionsEl.value) || 0;
            if (opportunitiesEl) appData.metrics.opportunities = parseInt(opportunitiesEl.value) || 0;
            if (risksEl) appData.metrics.risks = parseInt(risksEl.value) || 0;
            if (timeEl) appData.metrics.time = parseInt(timeEl.value) || 0;
            
            // Update metadata
            appData.lastUpdate = new Date().toISOString();
            appData.lastEditor = window.bafarHub.user?.username || 'Usuario';
            
            // Update hub data
            window.bafarHub.appData = appData;
            
            // Save locally only (no GitHub modal for every change)
            window.bafarHub.saveToLocal();
            
            // Show subtle notification
            window.bafarHub.showNotification('Cambios guardados localmente', 'success', 1500);
        }
        
        // GitHub auto-sync instance
        let gitHubAutoSync = null;
        
        // Manual save to GitHub (for explicit saves)
        async function saveToGitHub() {
            if (!window.bafarHub.isEditor) {
                window.bafarHub.showNotification('Solo los editores pueden guardar cambios', 'warning');
                return;
            }
            
            // Initialize GitHub auto-sync if not done
            if (!gitHubAutoSync) {
                gitHubAutoSync = new GitHubAutoSync();
                console.log('GitHub auto-sync initialized');
            }
            
            // Debug: Check if token is configured
            const token = localStorage.getItem('github_token');
            console.log('GitHub token status:', token ? 'Configured' : 'Not configured');
            
            const saveBtn = document.getElementById('saveGitHubBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '🔄 Guardando en GitHub...';
            }
            
            try {
                // Update metadata
                appData.lastUpdate = new Date().toISOString();
                appData.lastEditor = window.bafarHub.user ? window.bafarHub.user.username : 'Usuario';
                
                // Auto-commit to GitHub
                const result = await gitHubAutoSync.saveToGitHub(appData);
                
                if (result.success) {
                    // Show save indicator (safe call)
                    try {
                        const indicator = document.getElementById('saveIndicator');
                        if (indicator) {
                            indicator.style.display = 'block';
                            indicator.style.opacity = '1';
                            setTimeout(() => indicator.style.display = 'none', 2000);
                        }
                    } catch (e) { console.log('Save indicator not found'); }
                    
                    document.getElementById('syncStatusText').textContent = `✅ Guardado en GitHub - ${new Date().toLocaleTimeString()}`;
                    
                    // Also save locally as backup
                    window.bafarHub.appData = appData;
                    window.bafarHub.saveToLocal();
                    
                    // Show success notification
                    alert('✅ Datos guardados en GitHub correctamente!\\n\\nCommit: ' + result.sha || 'unknown');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error saving to GitHub:', error);
                
                if (error.message.includes('token') || error.message.includes('GITHUB_TOKEN_AQUI') || error.message.includes('no configurado')) {
                    // Need to setup private repository
                    const setupNow = confirm(
                        '🔐 Es necesario configurar el repositorio privado para guardar datos.\\n\\n' +
                        '¿Deseas abrir la página de configuración ahora?\\n\\n' +
                        '(Los datos se guardarán localmente mientras tanto)'
                    );
                    
                    if (setupNow) {
                        window.open('setup-private-repo.html', '_blank');
                    }
                } else {
                    alert(`Error al guardar en GitHub: ${error.message}\\n\\nGuardando localmente como respaldo.`);
                }
                
                // Always save locally as fallback
                appData.lastUpdate = new Date().toISOString();
                appData.lastEditor = window.bafarHub.user ? window.bafarHub.user.username : 'Usuario';
                window.bafarHub.appData = appData;
                window.bafarHub.saveToLocal();
                
                // Update status
                document.getElementById('syncStatusText').textContent = '💾 Guardado localmente - Sin conexión GitHub';
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 Sincronizar Cambios';
                }
            }
        }
        
        // Show GitHub token setup dialog
        function showGitHubTokenDialog() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3>🔑 Configurar GitHub Token</h3>
                    <p>Para guardar automáticamente en GitHub, necesitas configurar un token:</p>
                    
                    <ol style="text-align: left; margin: 20px 0;">
                        <li>Ve a <a href="https://github.com/settings/tokens" target="_blank">GitHub → Settings → Developer settings → Personal access tokens</a></li>
                        <li>Click "Generate new token (classic)"</li>
                        <li>Nombre: "BAFAR Intelligence Hub"</li>
                        <li>Selecciona: <strong>repo</strong> (Full control)</li>
                        <li>Click "Generate token"</li>
                        <li>Copia el token (empieza con ghp_)</li>
                    </ol>
                    
                    <div style="margin: 20px 0;">
                        <label>Pega tu GitHub Token aquí:</label><br>
                        <input type="password" id="githubTokenInput" placeholder="ghp_xxxxxxxxxxxxxxxx" style="width: 100%; padding: 10px; margin: 5px 0;">
                        <small style="color: #666;">El token se guardará localmente en tu navegador</small>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="saveGitHubToken()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                            💾 Guardar Token
                        </button>
                        <button onclick="closeGitHubTokenDialog()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.githubTokenModal = modal;
        }
        
        // Save GitHub token
        function saveGitHubToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) {
                alert('Por favor ingresa un token válido');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('El token debe empezar con "ghp_" o "github_pat_"');
                return;
            }
            
            // Save token locally
            localStorage.setItem('github_token', token);
            
            // Update auto-sync instance
            if (gitHubAutoSync) {
                gitHubAutoSync.setToken(token);
            }
            
            closeGitHubTokenDialog();
            alert('✅ Token guardado correctamente. Ahora puedes guardar en GitHub automáticamente.');
        }
        
        // Close token dialog
        function closeGitHubTokenDialog() {
            if (window.githubTokenModal) {
                document.body.removeChild(window.githubTokenModal);
                window.githubTokenModal = null;
            }
        }
        
        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.style.display = 'block';
                indicator.style.opacity = '1';
                
                // Hide after 2 seconds
                setTimeout(() => {
                    indicator.style.opacity = '0';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 300);
                }, 2000);
            }
        }
        
        // Show notification (fallback if bafarHub not available)
        function showNotification(message, type = 'info') {
            if (window.bafarHub && window.bafarHub.showNotification) {
                window.bafarHub.showNotification(message, type);
            } else {
                // Simple fallback notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                    color: white;
                    border-radius: 5px;
                    z-index: 9999;
                    font-family: Arial, sans-serif;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    animation: slideIn 0.3s ease-out;
                `;
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }

        // Auto-refresh interval
        let autoRefreshInterval = null;
        let lastKnownUpdate = null;
        
        // Collaborative editing state
        let editingLocks = {};
        
        // Generate unique session ID for this browser tab
        const sessionId = Math.random().toString(36).substring(2, 8);
        
        // Get user identifier from session (will be set after login)
        let currentUser = 'Usuario'; // Default fallback
        
        // Function to initialize current user from login session
        function initializeCurrentUser() {
            try {
                // Get user info from sessionStorage (set by login page)
                const userData = sessionStorage.getItem('user');
                if (userData) {
                    const user = JSON.parse(userData);
                    currentUser = user.username || 'Usuario';
                    
                    // Store for later use
                    localStorage.setItem('bafarHub_currentUser', currentUser);
                    
                    // Update display
                    const userNameElement = document.getElementById('currentUserName');
                    if (userNameElement) {
                        userNameElement.textContent = currentUser;
                    }
                    
                    // Store user role for admin checks
                    localStorage.setItem('bafarHub_userRole', user.role || 'viewer');
                    
                    console.log('✅ Usuario inicializado:', currentUser, 'Rol:', user.role);
                    
                    // Show admin functions if user is admin/editor
                    if (user.role === 'editor') {
                        const adminBtn = document.getElementById('adminUserMgmtBtn');
                        if (adminBtn) {
                            adminBtn.style.display = 'inline-block';
                        }
                    }
                } else {
                    console.log('⚠️ No se encontró información de usuario en sessionStorage');
                    currentUser = 'Usuario';
                }
            } catch (error) {
                console.error('Error al inicializar usuario:', error);
                currentUser = 'Usuario';
            }
        }
        
        // Add session ID to make each browser tab unique
        const uniqueUserId = `${currentUser}-${sessionId}`;
        
        // Use uniqueUserId for all editing locks
        let currentUserDisplay = currentUser; // For display purposes
        currentUser = uniqueUserId; // For lock identification
        
        // Start auto-refresh to detect changes from other users
        function startAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Set current lastUpdate as baseline
            lastKnownUpdate = appData.lastUpdate;
            
            // Check for updates every 30 seconds
            autoRefreshInterval = setInterval(async () => {
                try {
                    console.log('🔄 Checking for updates from other users...');
                    
                    // Load latest data from GitHub
                    const success = await window.bafarHub.loadFromGitHub();
                    if (success) {
                        const newData = window.bafarHub.appData;
                        
                        // Check if data was updated by someone else
                        if (newData.lastUpdate && newData.lastUpdate !== lastKnownUpdate) {
                            console.log('🆕 New changes detected from other user:', newData.lastEditor);
                            
                            // Check for editing conflicts before updating
                            checkEditingConflicts(newData);
                            
                            // Update our data (merge editing locks carefully)
                            const currentLocks = appData.editingLocks || {};
                            appData = newData;
                            
                            // Preserve our own locks if they're newer
                            if (!appData.editingLocks) {
                                appData.editingLocks = {};
                            }
                            
                            Object.keys(currentLocks).forEach(lockId => {
                                const currentLock = currentLocks[lockId];
                                const remoteLock = appData.editingLocks[lockId];
                                
                                // Keep our lock if it's ours and newer, or if remote doesn't exist
                                if (currentLock.user === currentUser && 
                                    (!remoteLock || new Date(currentLock.timestamp) > new Date(remoteLock.timestamp))) {
                                    appData.editingLocks[lockId] = currentLock;
                                }
                            });
                            
                            lastKnownUpdate = newData.lastUpdate;
                            
                            // Update UI
                            updateUI();
                            
                            // Show notification
                            showNotification(`🔄 Datos actualizados por ${newData.lastEditor || 'otro usuario'}`, 'info');
                            
                            // Update sync status
                            document.getElementById('syncStatusText').textContent = `🔄 Actualizado por ${newData.lastEditor} - ${new Date().toLocaleTimeString()}`;
                        }
                    }
                } catch (error) {
                    console.error('Auto-refresh error:', error);
                }
            }, 30000); // 30 seconds
            
            console.log('🔄 Auto-refresh started (checking every 30 seconds)');
        }
        
        // Función unificada para actualizar datos
        function refreshData() {
            console.log('🔄 RefreshData iniciado');
            
            if (!window.bafarHub) {
                console.error('❌ window.bafarHub no está disponible');
                alert('Error: Sistema no inicializado correctamente');
                return;
            }
            
            document.getElementById('syncStatusText').textContent = '🔄 Actualizando desde GitHub...';
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('refreshBtn').textContent = '🔄 Actualizando...';
            
            console.log('🔄 Llamando a window.bafarHub.loadFromGitHub()');
            window.bafarHub.loadFromGitHub().then(success => {
                console.log('🔄 LoadFromGitHub resultado:', success);
                if (success) {
                    appData = window.bafarHub.appData;
                    lastKnownUpdate = appData.lastUpdate; // Update baseline for auto-refresh
                    updateUI();
                    const now = new Date();
                    window.bafarHub.lastSync = now;
                    document.getElementById('syncStatusText').textContent = '✅ Conectado a GitHub - Datos actualizados';
                    document.getElementById('lastSyncTime').textContent = now.toLocaleTimeString();
                    showNotification('✅ Datos actualizados manualmente', 'success');
                } else {
                    console.log('❌ LoadFromGitHub failed');
                    document.getElementById('syncStatusText').textContent = '⚠️ Sin conexión - Usando datos locales';
                    showNotification('❌ Error al actualizar desde GitHub', 'error');
                }
            }).catch(error => {
                console.error('❌ Error en refreshData:', error);
                document.getElementById('syncStatusText').textContent = '❌ Error de conexión';
                showNotification('❌ Error: ' + error.message, 'error');
            }).finally(() => {
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('refreshBtn').textContent = '🔄 Actualizar Datos';
            });
        }

        // Funciones simplificadas - solo las necesarias
        function exportDataFile() {
            window.bafarHub.exportData();
        }

        function exportData(type) {
            window.bafarHub.exportData(type);
        }

        function generateResearchReport() {
            window.bafarHub.showNotification('Funcionalidad en desarrollo', 'info');
        }

        function generateMetricsReport() {
            window.bafarHub.showNotification('Funcionalidad en desarrollo', 'info');
        }

        function updateTimelineProgress() {
            window.bafarHub.showNotification('Funcionalidad en desarrollo', 'info');
        }

        function fixDataStructure() {
            window.bafarHub.showNotification('Estructura verificada', 'success');
        }

        function resetAllData() {
            if (!window.bafarHub.isEditor) return;
            
            if (confirm('¿Está seguro de reiniciar todos los datos? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('bafarHub');
                initDefaultData();
                updateUI();
                saveAllData();
                window.bafarHub.showNotification('Datos reiniciados correctamente', 'success');
            }
        }

        function showSection(sectionId, button) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            if (button) {
                document.querySelectorAll('.nav button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            }
            
            // Load users list when user management section is shown
            if (sectionId === 'usermanagement') {
                loadSystemUsersList();
            }
        }

        // Modal functions for unit details
        function openUnitModal(unitId) {
            const unit = appData.units.find(u => u.id === unitId);
            if (!unit) return;
            
            // Check if unit is being edited by another user
            if (appData.editingLocks && appData.editingLocks[`unit_${unitId}`]) {
                const lockInfo = appData.editingLocks[`unit_${unitId}`];
                const lockTime = new Date(lockInfo.timestamp);
                const now = new Date();
                const minutesAgo = (now - lockTime) / (1000 * 60);
                
                // If lock is less than 5 minutes old and not by current user
                if (minutesAgo < 5 && lockInfo.user !== currentUser) {
                    // Extract display name from user ID (format: "Name-sessionId")
                    const displayName = lockInfo.user.split('-').slice(0, -1).join('-') || lockInfo.user;
                    const confirm = window.confirm(
                        `⚠️ ATENCIÓN: Esta unidad está siendo editada por "${displayName}"\n\n` +
                        `Editado hace ${Math.round(minutesAgo)} minutos.\n\n` +
                        `Si continúas, podrías sobrescribir sus cambios.\n\n` +
                        `¿Quieres continuar de todos modos?`
                    );
                    
                    if (!confirm) return;
                }
            }
            
            // Set editing lock
            setEditingLock(`unit_${unitId}`, currentUser);
            
            // Fill form with current data
            document.getElementById('unitName').value = unit.name;
            document.getElementById('unitResponsible').value = unit.responsible || '';
            document.getElementById('unitEmail').value = unit.email || '';
            document.getElementById('unitFrequency').value = unit.frequency || 'Semanal';
            document.getElementById('unitStatus').value = unit.status || 'Pendiente';
            document.getElementById('unitLocation').value = unit.location || '';
            document.getElementById('unitBudget').value = unit.budget || '';
            document.getElementById('unitEmployees').value = unit.employees || '';
            document.getElementById('unitRevenue').value = unit.revenue || '';
            document.getElementById('unitGoals').value = unit.goals || '';
            document.getElementById('unitKPIs').value = unit.kpis || '';
            
            // Store current unit ID
            window.currentUnitId = unitId;
            
            // Show modal with editing indicator
            document.getElementById('unitModal').style.display = 'flex';
            updateModalHeader(unit.name);
            
            // Switch to first tab
            switchUnitTab('generalTab');
            
            // Load organigrama if exists
            loadOrgChart(unitId);
            
            // Auto-refresh lock every 2 minutes while editing
            if (window.editingLockInterval) {
                clearInterval(window.editingLockInterval);
            }
            window.editingLockInterval = setInterval(() => {
                if (window.currentUnitId) {
                    setEditingLock(`unit_${window.currentUnitId}`, currentUser);
                }
            }, 120000); // 2 minutes
        }
        
        function closeUnitModal() {
            // Release editing lock
            if (window.currentUnitId) {
                releaseEditingLock(`unit_${window.currentUnitId}`);
            }
            
            // Clear editing interval
            if (window.editingLockInterval) {
                clearInterval(window.editingLockInterval);
                window.editingLockInterval = null;
            }
            
            document.getElementById('unitModal').style.display = 'none';
            window.currentUnitId = null;
        }
        
        // Editing lock functions
        function setEditingLock(resourceId, user) {
            if (!appData.editingLocks) {
                appData.editingLocks = {};
            }
            
            appData.editingLocks[resourceId] = {
                user: user,
                timestamp: new Date().toISOString()
            };
            
            // Save to local storage immediately
            localStorage.setItem('bafarHub', JSON.stringify(appData));
        }
        
        function releaseEditingLock(resourceId) {
            if (appData.editingLocks && appData.editingLocks[resourceId]) {
                delete appData.editingLocks[resourceId];
                localStorage.setItem('bafarHub', JSON.stringify(appData));
            }
        }
        
        function updateModalHeader(unitName) {
            const header = document.querySelector('#unitModal .unit-modal-header h2');
            if (header) {
                header.innerHTML = `
                    <span id="modalUnitIcon">🏢</span>
                    <span id="modalUnitName">${unitName}</span>
                    <span style="font-size: 12px; color: #28a745; margin-left: 10px;">
                        ✏️ Editando como ${currentUser}
                    </span>
                `;
            }
        }
        
        // Check for editing conflicts on auto-refresh
        function checkEditingConflicts(newData) {
            if (!newData.editingLocks) return;
            
            Object.keys(newData.editingLocks).forEach(resourceId => {
                const lockInfo = newData.editingLocks[resourceId];
                const lockTime = new Date(lockInfo.timestamp);
                const now = new Date();
                const minutesAgo = (now - lockTime) / (1000 * 60);
                
                // Show warning if someone else is editing
                if (minutesAgo < 5 && lockInfo.user !== currentUser) {
                    const resourceName = resourceId.replace('unit_', 'Unidad ');
                    showNotification(
                        `⚠️ ${lockInfo.user} está editando ${resourceName}`, 
                        'warning'
                    );
                }
            });
        }
        
        function switchUnitTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.unit-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.unit-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById(tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Add active class to corresponding button
            const buttonId = tabId.replace('Tab', 'Btn');
            const targetBtn = document.getElementById(buttonId);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // If switching to organigrama tab, refresh it
            if (tabId === 'organigramaTab' && window.currentUnitId) {
                loadOrgChart(window.currentUnitId);
            }
        }
        
        function saveUnitDetails() {
            if (!window.currentUnitId) return;
            
            const unitId = window.currentUnitId;
            const unitIndex = appData.units.findIndex(u => u.id === unitId);
            
            if (unitIndex === -1) return;
            
            // Update unit data
            const unit = appData.units[unitIndex];
            unit.name = document.getElementById('unitName').value;
            unit.responsible = document.getElementById('unitResponsible').value;
            unit.email = document.getElementById('unitEmail').value;
            unit.frequency = document.getElementById('unitFrequency').value;
            unit.status = document.getElementById('unitStatus').value;
            unit.location = document.getElementById('unitLocation').value;
            unit.budget = document.getElementById('unitBudget').value;
            unit.employees = document.getElementById('unitEmployees').value;
            unit.revenue = document.getElementById('unitRevenue').value;
            unit.goals = document.getElementById('unitGoals').value;
            unit.kpis = document.getElementById('unitKPIs').value;
            
            // Save to storage and sync
            saveAllData();
            
            // Update UI
            updateUI();
            
            // Close modal
            closeUnitModal();
            
            showNotification('✅ Detalles de unidad guardados', 'success');
        }
        
        function loadOrgChart(unitId) {
            const container = document.getElementById('orgChartContainer');
            
            // Get organizational data for this unit
            const orgData = appData.organizational?.[unitId] || [];
            
            if (orgData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay estructura organizacional definida. Haz click en "Agregar Posición" para comenzar.</p>';
                return;
            }
            
            // Generate org chart HTML
            let html = '<div class="org-chart">';
            
            // Find root positions (no parent)
            const roots = orgData.filter(pos => !pos.parentId);
            
            roots.forEach(root => {
                html += renderOrgPosition(root, orgData, 0);
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderOrgPosition(position, allPositions, level) {
            const children = allPositions.filter(pos => pos.parentId === position.id);
            
            let html = `
                <div class="org-position level-${level}">
                    <div class="org-card">
                        <div class="org-title">${position.title}</div>
                        <div class="org-name">${position.name || 'Sin asignar'}</div>
                        <div class="org-actions">
                            <button onclick="editOrgPosition('${position.id}')" class="btn-small">✏️</button>
                            <button onclick="deleteOrgPosition('${position.id}')" class="btn-small">🗑️</button>
                        </div>
                    </div>
            `;
            
            if (children.length > 0) {
                html += '<div class="org-children">';
                children.forEach(child => {
                    html += renderOrgPosition(child, allPositions, level + 1);
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        function addOrgPosition() {
            if (!window.currentUnitId) return;
            
            // Initialize organizational structure
            if (!appData.organizational) {
                appData.organizational = {};
            }
            
            if (!appData.organizational[window.currentUnitId]) {
                appData.organizational[window.currentUnitId] = [];
            }
            
            // Clear form
            document.getElementById('orgPositionTitle').value = '';
            document.getElementById('orgPositionName').value = '';
            document.getElementById('orgPositionEmail').value = '';
            document.getElementById('orgFormTitle').textContent = '➕ Agregar Nueva Posición';
            
            // Setup supervisor options
            setupSupervisorOptions();
            
            // Show form modal
            document.getElementById('orgFormModal').style.display = 'flex';
            
            // Focus on title field
            setTimeout(() => {
                document.getElementById('orgPositionTitle').focus();
            }, 100);
        }
        
        function setupSupervisorOptions(excludeId = null) {
            const container = document.getElementById('supervisorOptions');
            const existingPositions = appData.organizational[window.currentUnitId] || [];
            
            // Filter out the position being edited and its descendants
            let availablePositions = existingPositions.filter(pos => {
                if (!excludeId) return true; // If not editing, all positions available
                if (pos.id === excludeId) return false; // Can't be supervisor of itself
                return !isDescendant(pos.id, excludeId, existingPositions); // Can't be supervisor of ancestor
            });
            
            let html = `
                <div class="supervisor-option selected" data-parent-id="null">
                    <h5>🔝 Sin supervisor directo</h5>
                    <p>Esta es una posición de nivel superior (Director, Gerente General, etc.)</p>
                </div>
            `;
            
            availablePositions.forEach(pos => {
                html += `
                    <div class="supervisor-option" data-parent-id="${pos.id}">
                        <h5>${pos.title}</h5>
                        <p>${pos.name || 'Sin asignar'}${pos.email ? ' • ' + pos.email : ''}</p>
                    </div>
                `;
            });
            
            if (availablePositions.length === 0) {
                html += `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>No hay otras posiciones disponibles como supervisores</p>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Add click handlers for supervisor selection
            container.querySelectorAll('.supervisor-option').forEach(option => {
                option.addEventListener('click', () => {
                    container.querySelectorAll('.supervisor-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                });
            });
        }
        
        function closeOrgForm() {
            document.getElementById('orgFormModal').style.display = 'none';
            window.editingPositionId = null;
        }
        
        function handleOrgFormSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('orgPositionTitle').value.trim();
            const name = document.getElementById('orgPositionName').value.trim();
            const email = document.getElementById('orgPositionEmail').value.trim();
            
            if (!title) {
                alert('Por favor ingresa el título del puesto');
                return;
            }
            
            // Get selected supervisor
            const selectedSupervisor = document.querySelector('.supervisor-option.selected');
            const parentId = selectedSupervisor ? selectedSupervisor.dataset.parentId : null;
            const finalParentId = parentId === 'null' ? null : parentId;
            
            if (window.editingPositionId) {
                // Edit existing position
                const position = appData.organizational[window.currentUnitId].find(pos => pos.id === window.editingPositionId);
                if (position) {
                    position.title = title;
                    position.name = name;
                    position.email = email;
                    position.parentId = finalParentId;
                    
                    showNotification(`✅ Posición "${title}" actualizada`, 'success');
                }
            } else {
                // Add new position
                const newPosition = {
                    id: Date.now().toString(),
                    title: title,
                    name: name,
                    email: email,
                    unitId: window.currentUnitId,
                    parentId: finalParentId
                };
                
                appData.organizational[window.currentUnitId].push(newPosition);
                showNotification(`✅ Posición "${title}" agregada`, 'success');
            }
            
            // Reload org chart and save data
            loadOrgChart(window.currentUnitId);
            saveAllData();
            closeOrgForm();
        }
        
        // Add form submit handler
        document.addEventListener('DOMContentLoaded', () => {
            const orgForm = document.getElementById('orgPositionForm');
            if (orgForm) {
                orgForm.addEventListener('submit', handleOrgFormSubmit);
            }
        });
        
        function editOrgPosition(positionId) {
            const orgData = appData.organizational[window.currentUnitId];
            const position = orgData.find(pos => pos.id === positionId);
            
            if (!position) return;
            
            // Set form to edit mode
            window.editingPositionId = positionId;
            
            // Fill form with existing data
            document.getElementById('orgPositionTitle').value = position.title || '';
            document.getElementById('orgPositionName').value = position.name || '';
            document.getElementById('orgPositionEmail').value = position.email || '';
            document.getElementById('orgFormTitle').textContent = '✏️ Editar Posición';
            
            // Setup supervisor options (excluding this position and its descendants)
            setupSupervisorOptions(positionId);
            
            // Select current supervisor
            setTimeout(() => {
                const currentSupervisorId = position.parentId || 'null';
                const supervisorOption = document.querySelector(`.supervisor-option[data-parent-id="${currentSupervisorId}"]`);
                if (supervisorOption) {
                    document.querySelectorAll('.supervisor-option').forEach(opt => opt.classList.remove('selected'));
                    supervisorOption.classList.add('selected');
                }
            }, 100);
            
            // Show form modal
            document.getElementById('orgFormModal').style.display = 'flex';
            
            // Focus on title field
            setTimeout(() => {
                document.getElementById('orgPositionTitle').focus();
            }, 100);
        }
        
        // Helper function to check if position is descendant of another
        function isDescendant(positionId, ancestorId, orgData) {
            const position = orgData.find(pos => pos.id === positionId);
            if (!position || !position.parentId) return false;
            
            if (position.parentId === ancestorId) return true;
            
            return isDescendant(position.parentId, ancestorId, orgData);
        }
        
        function deleteOrgPosition(positionId) {
            if (!confirm('¿Eliminar esta posición?')) return;
            
            const orgData = appData.organizational[window.currentUnitId];
            const index = orgData.findIndex(pos => pos.id === positionId);
            
            if (index !== -1) {
                orgData.splice(index, 1);
                loadOrgChart(window.currentUnitId);
                saveAllData();
            }
        }
        
        // Add click handlers to business units table
        function makeUnitsClickable() {
            // Add click handlers when units table is rendered
            setTimeout(() => {
                const rows = document.querySelectorAll('#unitsTableBody tr');
                rows.forEach((row, index) => {
                    const unitId = appData.units[index]?.id;
                    
                    // Check if unit is being edited
                    const isBeingEdited = appData.editingLocks && appData.editingLocks[`unit_${unitId}`];
                    
                    if (isBeingEdited) {
                        const lockInfo = appData.editingLocks[`unit_${unitId}`];
                        const lockTime = new Date(lockInfo.timestamp);
                        const now = new Date();
                        const minutesAgo = (now - lockTime) / (1000 * 60);
                        
                        if (minutesAgo < 5) {
                            // Add visual indicator for editing
                            row.style.backgroundColor = lockInfo.user === currentUser ? '#e8f5e9' : '#fff3e0';
                            row.style.borderLeft = lockInfo.user === currentUser ? '4px solid #4caf50' : '4px solid #ff9800';
                            
                            // Add editing indicator in the last cell
                            const lastCell = row.cells[row.cells.length - 1];
                            if (lastCell) {
                                const displayName = lockInfo.user.split('-').slice(0, -1).join('-') || lockInfo.user;
                                const editingIndicator = lockInfo.user === currentUser ? 
                                    `<span style="color: #4caf50; font-size: 12px;">✏️ Editando</span>` :
                                    `<span style="color: #ff9800; font-size: 12px;">⚠️ ${displayName}</span>`;
                                lastCell.innerHTML = editingIndicator + '<br>' + lastCell.innerHTML;
                            }
                        }
                    }
                    
                    row.style.cursor = 'pointer';
                    row.onclick = () => {
                        if (unitId) {
                            openUnitModal(unitId);
                        }
                    };
                });
            }, 100);
        }

        // =================== USER MANAGEMENT FUNCTIONS ===================
        
        // Add new user to the system
        function addNewUser() {
            const username = document.getElementById('newUserUsername').value.trim();
            const fullName = document.getElementById('newUserFullName').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!username || !fullName || !password) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }
            
            try {
                // Get current users from localStorage
                let users = JSON.parse(localStorage.getItem('bafarUsers') || '{}');
                
                // Check if user already exists
                if (users[username.toLowerCase()]) {
                    alert('El usuario ya existe. Usa un nombre diferente.');
                    return;
                }
                
                // Add new user
                users[username.toLowerCase()] = {
                    password: password,
                    role: role,
                    name: fullName
                };
                
                // Save users
                localStorage.setItem('bafarUsers', JSON.stringify(users));
                
                // Clear form
                document.getElementById('newUserUsername').value = '';
                document.getElementById('newUserFullName').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserRole').value = 'editor';
                
                // Reload users list
                loadSystemUsersList();
                
                showNotification(`Usuario ${fullName} agregado exitosamente`, 'success');
                
            } catch (error) {
                console.error('Error al agregar usuario:', error);
                alert('Error al agregar usuario: ' + error.message);
            }
        }
        
        // Load and display system users list
        function loadSystemUsersList() {
            try {
                const users = JSON.parse(localStorage.getItem('bafarUsers') || '{}');
                const container = document.getElementById('systemUsersList');
                
                if (Object.keys(users).length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay usuarios registrados</p>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 15px;">';
                
                for (const [username, userData] of Object.entries(users)) {
                    const roleText = userData.role === 'editor' ? 'Administrador' : 'Solo Lectura';
                    const roleColor = userData.role === 'editor' ? '#4caf50' : '#ffa500';
                    const isCurrentUser = currentUser && currentUser.toLowerCase() === userData.name.toLowerCase();
                    
                    html += `
                        <div style="
                            background: ${isCurrentUser ? 'rgba(0, 136, 255, 0.1)' : 'rgba(0, 136, 255, 0.05)'};
                            padding: 15px;
                            border-radius: 8px;
                            border: ${isCurrentUser ? '2px solid #0088ff' : '1px solid #e0e0e0'};
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div>
                                <div style="font-weight: bold; color: #333;">
                                    ${userData.name} ${isCurrentUser ? '(Tú)' : ''}
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    Usuario: ${username}
                                </div>
                                <div style="
                                    display: inline-block;
                                    background: ${roleColor};
                                    color: white;
                                    padding: 4px 8px;
                                    border-radius: 4px;
                                    font-size: 11px;
                                    font-weight: bold;
                                    margin-top: 8px;
                                ">
                                    ${roleText}
                                </div>
                            </div>
                            <div>
                                ${!isCurrentUser ? `
                                    <button 
                                        onclick="deleteSystemUser('${username}')" 
                                        style="
                                            background: #dc3545;
                                            color: white;
                                            border: none;
                                            padding: 8px 12px;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 12px;
                                        "
                                        onmouseover="this.style.background='#c82333'"
                                        onmouseout="this.style.background='#dc3545'"
                                    >
                                        🗑️ Eliminar
                                    </button>
                                ` : '<span style="color: #28a745; font-size: 12px;">✅ Usuario Activo</span>'}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error al cargar lista de usuarios:', error);
                document.getElementById('systemUsersList').innerHTML = 
                    '<p style="color: #dc3545;">Error al cargar usuarios</p>';
            }
        }
        
        // Delete a system user
        function deleteSystemUser(username) {
            if (!confirm(`¿Estás seguro de que deseas eliminar al usuario "${username}"?`)) {
                return;
            }
            
            try {
                let users = JSON.parse(localStorage.getItem('bafarUsers') || '{}');
                
                if (users[username]) {
                    delete users[username];
                    localStorage.setItem('bafarUsers', JSON.stringify(users));
                    loadSystemUsersList();
                    showNotification(`Usuario ${username} eliminado`, 'success');
                } else {
                    alert('Usuario no encontrado');
                }
                
            } catch (error) {
                console.error('Error al eliminar usuario:', error);
                alert('Error al eliminar usuario: ' + error.message);
            }
        }
        
        // =================== END USER MANAGEMENT FUNCTIONS ===================
        
        // Open private repository setup page
        function openPrivateRepoSetup() {
            window.open('setup-private-repo.html', '_blank');
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Auto-save every 60 seconds
        setInterval(saveAllData, 60000);
    </script>
</body>
</html>