<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAFAR Intelligence Hub - Centro de Inteligencia Competitiva</title>
    <style>
        /* Base styles - Reset and typography */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Typography */
        h2 {
            color: #1e3a5f;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #c41e3a;
            font-weight: 600;
        }

        h3 {
            color: #2c4158;
            font-size: 1.3em;
            margin: 25px 0 15px 0;
            font-weight: 600;
        }

        /* Layout */
        .content {
            padding: 30px 40px;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Header */
        .header {
            background: #1e3a5f;
            color: white;
            padding: 30px 40px;
            border-bottom: 4px solid #c41e3a;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        /* Sync status indicator */
        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .sync-local { background: #ffc107; animation: none; }
        .sync-error { background: #dc3545; animation: none; }

        /* Mode indicator */
        .mode-indicator {
            position: absolute;
            top: 60px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Navigation */
        .nav {
            background: #2c4158;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: flex-start;
            overflow-x: auto;
            border-bottom: 1px solid #e0e0e0;
        }

        .nav button {
            background: none;
            border: none;
            color: white;
            padding: 14px 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .nav button:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav button.active {
            background: #c41e3a;
            font-weight: 600;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            padding: 20px;
            text-align: center;
            transition: box-shadow 0.2s;
            border-radius: 8px;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #1e3a5f;
            margin: 8px 0;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Tables */
        .data-container {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: #2c4158;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
        }

        .data-table td {
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
        }

        .data-table input, 
        .data-table select, 
        .data-table textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
            border-radius: 4px;
        }

        .data-table textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* Buttons */
        .btn {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            margin: 5px;
            border-radius: 4px;
        }

        .btn:hover {
            background: #2c4158;
        }

        .btn-primary {
            background: #c41e3a;
        }

        .btn-primary:hover {
            background: #a01729;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Process Flow */
        .process-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            padding: 25px;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            overflow-x: auto;
            border-radius: 8px;
        }

        .process-step {
            flex: 1;
            text-align: center;
            position: relative;
            min-width: 140px;
        }

        .step-icon {
            width: 70px;
            height: 70px;
            background: #1e3a5f;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .step-title {
            font-weight: 600;
            color: #1e3a5f;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .step-time {
            color: #666;
            font-size: 12px;
        }

        /* Alerts */
        .alert {
            padding: 15px 20px;
            margin: 20px 0;
            border-left: 4px solid;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .alert-info {
            border-left-color: #1e3a5f;
            background: #e7f3ff;
        }

        .alert-success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .alert-warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .alert-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        /* Sync Panel */
        .sync-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .sync-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Intelligence Needs Grid */
        .needs-grid {
            display: grid;
            gap: 20px;
            margin: 30px 0;
        }

        .unit-needs {
            border: 1px solid #e0e0e0;
            background: white;
            overflow: hidden;
            border-radius: 8px;
        }

        .unit-header {
            background: #2c4158;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .unit-body {
            padding: 20px;
        }

        .needs-section {
            margin-bottom: 20px;
        }

        .needs-section h5 {
            color: #1e3a5f;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .needs-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
            min-height: 80px;
            resize: vertical;
            border-radius: 4px;
        }

        .metric-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            min-height: 40px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            border-radius: 4px;
        }

        /* Research Matrix Styles */
        .unit-research-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .unit-research-header {
            background: #2c4158;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .unit-research-header:hover {
            background: #34495e;
        }

        .unit-research-header h3 {
            margin: 0;
            color: white;
            font-size: 18px;
        }

        .unit-info {
            display: flex;
            gap: 30px;
            font-size: 14px;
            opacity: 0.9;
        }

        .unit-research-body {
            padding: 20px;
            background: #fafafa;
        }

        .research-topics-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .research-topics-table th {
            background: #e9ecef;
            color: #2c4158;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .research-topics-table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            font-size: 14px;
        }

        .research-topics-table input,
        .research-topics-table select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .add-topic-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
        }

        .add-topic-btn:hover {
            background: #218838;
        }

        .remove-topic-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-topic-btn:hover {
            background: #c82333;
        }

        .unit-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 4px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .summary-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c4158;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expanded .expand-icon {
            transform: rotate(180deg);
        }

        .priority-high {
            background: #ffebee;
        }

        .priority-medium {
            background: #fff3e0;
        }

        .priority-low {
            background: #e8f5e9;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 25px;
            position: relative;
        }

        .timeline-date {
            min-width: 120px;
            font-weight: 600;
            color: #c41e3a;
            font-size: 14px;
        }

        .timeline-content {
            flex: 1;
            background: #fafafa;
            padding: 15px;
            border-left: 3px solid #c41e3a;
            margin-left: 20px;
            border-radius: 0 8px 8px 0;
        }

        /* Progress Bar */
        .progress-container {
            background: #e9ecef;
            height: 40px;
            margin: 20px 0;
            position: relative;
            border-radius: 20px;
            overflow: hidden;
        }

        .progress-bar {
            background: #c41e3a;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
            font-size: 14px;
        }

        /* Action buttons container */
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 10000;
        }

        /* Loading indicator */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-size: 14px;
            color: #1e3a5f;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1e3a5f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .unit-info {
                flex-direction: column;
                gap: 10px;
            }

            .timeline-item {
                flex-direction: column;
            }

            .timeline-date {
                min-width: auto;
                margin-bottom: 10px;
            }

            .timeline-content {
                margin-left: 0;
                border-left: none;
                border-top: 3px solid #c41e3a;
                border-radius: 8px;
            }

            .sync-status {
                position: static;
                margin-top: 10px;
                justify-self: flex-start;
            }

            .mode-indicator {
                position: static;
                margin-top: 5px;
            }

            .sync-actions {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>BAFAR INTELLIGENCE HUB</h1>
            <p>Centro de Inteligencia Competitiva - Modo Colaborativo</p>
            <div class="sync-status" id="syncStatus">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncText">Inicializando...</span>
            </div>
            <div class="mode-indicator" id="modeIndicator">Modo Local</div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button onclick="showSection('dashboard', this)" class="active">Dashboard</button>
            <button onclick="showSection('units', this)">Unidades de Negocio</button>
            <button onclick="showSection('needs', this)">Necesidades de Información</button>
            <button onclick="showSection('research', this)">Matriz de Investigación</button>
            <button onclick="showSection('timeline', this)">Cronograma</button>
            <button onclick="showSection('metrics', this)">Métricas</button>
        </nav>

        <div class="content">
            <!-- DASHBOARD SECTION -->
            <section id="dashboard" class="section active">
                <h2>Dashboard Ejecutivo</h2>
                
                <div class="alert alert-info">
                    <strong>Objetivo del Proyecto:</strong> Implementar en 90 días un sistema de gestión del conocimiento que proporcione inteligencia competitiva personalizada para cada unidad de negocio.
                </div>

                <!-- Sync Panel -->
                <div class="sync-panel">
                    <h4>🔄 Estado de Sincronización</h4>
                    <p><strong>Estado:</strong> <span id="syncStatusText">Conectando...</span></p>
                    <p><strong>Última actualización:</strong> <span id="lastSyncTime">Nunca</span></p>
                    <div class="sync-actions">
                        <button class="btn btn-primary btn-small" onclick="refreshData()" id="refreshBtn">🔄 Actualizar Datos</button>
                        <button class="btn btn-success btn-small" onclick="saveToGitHub()" id="saveGitHubBtn">💾 Sincronizar Cambios</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        💡 Los cambios se guardan automáticamente. Usa "Sincronizar" para compartir con el equipo.
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Días Restantes</div>
                        <div class="stat-number" id="daysRemaining">90</div>
                        <div class="stat-label">
                            Fecha Inicio: 
                            <input type="date" id="startDateInput" onchange="updateStartDate(this.value)" 
                                   style="border: none; background: transparent; color: #666; font-size: 12px; margin-top: 5px; ${!window.bafarHub?.isEditor ? 'pointer-events: none;' : ''}" 
                                   ${!window.bafarHub?.isEditor ? 'disabled' : ''}>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unidades Activas</div>
                        <div class="stat-number" id="unitsCount">0</div>
                        <div class="stat-label">Total Configuradas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Progreso Sprint</div>
                        <div class="stat-number" id="progressPercent">0%</div>
                        <div class="stat-label">Fase: Configuración</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Última Sincronización</div>
                        <div class="stat-number" id="lastSync">Nunca</div>
                        <div class="stat-label">Modo: <span id="currentMode">Local</span></div>
                    </div>
                </div>

                <h3>Flujo de Procesamiento de Inteligencia</h3>
                <div class="process-flow">
                    <div class="process-step">
                        <div class="step-icon">1</div>
                        <div class="step-title">CAPTURA</div>
                        <div class="step-time">30 min/día</div>
                    </div>
                    <div class="process-step">
                        <div class="step-icon">2</div>
                        <div class="step-title">VALIDACIÓN</div>
                        <div class="step-time">15 min/doc</div>
                    </div>
                    <div class="process-step">
                        <div class="step-icon">3</div>
                        <div class="step-title">SÍNTESIS</div>
                        <div class="step-time">15 min/doc</div>
                    </div>
                    <div class="process-step">
                        <div class="step-icon">4</div>
                        <div class="step-title">DISTRIBUCIÓN</div>
                        <div class="step-time">Automática</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="fixDataStructure()">Reparar Estructura de Datos</button>
                    <button class="btn btn-danger" onclick="resetAllData()">Reiniciar Todo</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub</button>
                </div>
            </section>

            <!-- BUSINESS UNITS SECTION -->
            <section id="units" class="section">
                <h2>Configuración de Unidades de Negocio</h2>
                
                <div class="data-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Registro de Unidades y Responsables</h3>
                        <div>
                            <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub</button>
                        </div>
                    </div>

                    <!-- Add Unit Form -->
                    <div id="addUnitForm" style="background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="newUnitName" placeholder="Nombre de la nueva unidad" style="flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                            <button class="btn" onclick="addUnitFromForm()">+ Agregar Unidad</button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Unidad de Negocio</th>
                                <th width="20%">Responsable</th>
                                <th width="20%">Email</th>
                                <th width="10%">Frecuencia</th>
                                <th width="10%">Estado</th>
                                <th width="10%">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <!-- Units will be added here -->
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                        <small><strong>Nota:</strong> Los cambios se guardan automáticamente en tu navegador. Usa "Cargar Datos Compartidos" para obtener la versión más reciente del administrador.</small>
                    </div>
                </div>
            </section>

            <!-- INTELLIGENCE NEEDS SECTION -->
            <section id="needs" class="section">
                <h2>Necesidades de Información por Unidad</h2>
                
                <div class="alert alert-info">
                    Configure las necesidades específicas de información para cada unidad de negocio. Los cambios se guardan automáticamente en su equipo.
                </div>

                <div id="needsContainer" class="needs-grid">
                    <!-- Needs forms will be added here -->
                </div>
                
                <div id="emptyNeedsMessage" style="display: none; padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                    <p style="color: #6c757d; font-size: 16px;">No hay unidades de negocio configuradas.</p>
                    <p style="color: #6c757d;">Agregue unidades en la pestaña "Unidades de Negocio" para configurar sus necesidades de información.</p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="exportData('needs')">Exportar Necesidades</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub Necesidades</button>
                </div>
            </section>

            <!-- RESEARCH MATRIX SECTION -->
            <section id="research" class="section">
                <h2>Matriz de Investigación</h2>
                
                <div class="alert alert-info">
                    Configure los tópicos de investigación específicos para cada unidad de negocio, asigne responsables y establezca frecuencias de actualización.
                </div>

                <div id="researchMatrixContainer">
                    <!-- Research matrix cards will be populated here -->
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="generateResearchReport()">Generar Reporte</button>
                    <button class="btn btn-secondary" onclick="exportData('research')">Exportar Matriz</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub Matriz de Investigación</button>
                </div>
            </section>

            <!-- TIMELINE SECTION -->
            <section id="timeline" class="section">
                <h2>Cronograma de Implementación - 90 Días</h2>
                
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 1-2</div>
                        <div class="timeline-content">
                            <strong>FASE 1: DESCUBRIMIENTO</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Entrevistas con ejecutivos</li>
                                <li>Mapeo de necesidades</li>
                                <li>Configuración de herramientas</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 85%; font-size: 12px;">85% Completado</div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 3-8</div>
                        <div class="timeline-content">
                            <strong>FASE 2: INVESTIGACIÓN INTENSIVA</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Producción de 30-40 documentos</li>
                                <li>Creación de biblioteca digital</li>
                                <li>Desarrollo de dashboards</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 25%; font-size: 12px;">25% En Progreso</div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 9-10</div>
                        <div class="timeline-content">
                            <strong>FASE 3: PLATAFORMA DIGITAL</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Implementación de blog interno</li>
                                <li>Migración de contenido</li>
                                <li>Sistema de distribución</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 5%; font-size: 12px;">5% Planeado</div>
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-date">Semanas 11-12</div>
                        <div class="timeline-content">
                            <strong>FASE 4: LANZAMIENTO</strong>
                            <ul style="margin: 10px 0 10px 20px;">
                                <li>Campaña de comunicación</li>
                                <li>Capacitación de usuarios</li>
                                <li>Medición y ajustes</li>
                            </ul>
                            <div class="progress-container" style="height: 20px;">
                                <div class="progress-bar" style="width: 0%; font-size: 12px;">0% Pendiente</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="exportData('timeline')">Exportar Cronograma</button>
                    <button class="btn btn-primary" onclick="updateTimelineProgress()">Actualizar Progreso</button>
                </div>
            </section>

            <!-- METRICS SECTION -->
            <section id="metrics" class="section">
                <h2>Métricas de Éxito</h2>
                
                <h3>KPIs de Impacto del Negocio</h3>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-label">Decisiones Informadas</div>
                        <input type="number" id="metricDecisions" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: 10 por mes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Oportunidades ($MXN)</div>
                        <input type="text" id="metricOpportunities" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: $1M MXN</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Riesgos Mitigados</div>
                        <input type="number" id="metricRisks" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: 5 críticos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tiempo Ahorrado (hrs)</div>
                        <input type="number" id="metricTime" class="metric-input" placeholder="0" onchange="saveAllData()">
                        <div class="stat-label">Meta: 100 hrs/mes</div>
                    </div>
                </div>

                <h3>Análisis de Rendimiento</h3>
                <div class="data-container">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div>
                            <h4>Resumen del Mes</h4>
                            <div id="monthlyMetrics">
                                <!-- Monthly metrics will be calculated here -->
                            </div>
                        </div>
                        <div>
                            <h4>Comparación con Objetivos</h4>
                            <div id="goalComparison">
                                <!-- Goal comparison will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="generateMetricsReport()">Generar Reporte de Métricas</button>
                    <button class="btn btn-secondary" onclick="exportData('metrics')">Exportar Datos</button>
                    <button class="btn btn-primary" onclick="saveToGitHub()">💾 Guardar en GitHub Métricas</button>
                </div>
            </section>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        Datos guardados correctamente
    </div>

    <script src="bafar-intelligence-hub.js"></script>
    <script src="sharepoint-connector.js"></script>
    <script src="github-auto-sync.js"></script>
    <script>
        // Global data structure
        let appData = {
            units: [],
            needs: {},
            research: {},
            metrics: {},
            startDate: new Date().toISOString().split('T')[0],
            progress: 5
        };

        // Initialize the application
        function initApp() {
            // Check user session first
            if (!window.bafarHub.checkUserSession()) {
                window.location.href = 'index.html';
                return;
            }

            // Initialize sync status
            document.getElementById('syncStatusText').textContent = 'Conectando...';

            // First load local data if available
            const hasLocalData = loadFromLocal();
            
            // Then try to sync with GitHub (but respect local newer data)
            window.bafarHub.loadFromGitHub().then(success => {
                console.log('GitHub load result:', success);
                if (success) {
                    appData = window.bafarHub.appData;
                    const now = new Date();
                    window.bafarHub.lastSync = now;
                    
                    // Update sync status based on what happened
                    const status = window.bafarHub.updateSyncStatus;
                    if (status === 'local-newer') {
                        document.getElementById('syncStatusText').textContent = '💾 Usando tus datos locales (más recientes)';
                    } else {
                        document.getElementById('syncStatusText').textContent = '✅ Conectado a GitHub - Datos actualizados';
                    }
                    document.getElementById('lastSyncTime').textContent = now.toLocaleTimeString();
                } else {
                    console.log('GitHub failed, using local data');
                    document.getElementById('syncStatusText').textContent = '⚠️ Modo Local - Sin conexión a GitHub';
                    document.getElementById('lastSyncTime').textContent = 'Local';
                }
                updateUI();
                // Don't auto-sync to avoid overwriting local changes
                // window.bafarHub.startAutoSync();
            }).catch(error => {
                console.error('Error connecting to GitHub:', error);
                document.getElementById('syncStatusText').textContent = '💾 Usando datos locales guardados';
                document.getElementById('lastSyncTime').textContent = 'Local';
                updateUI();
            });
        }

        // Load from local storage
        function loadFromLocal() {
            const saved = localStorage.getItem('bafarHub');
            if (saved) {
                try {
                    appData = JSON.parse(saved);
                    window.bafarHub.appData = appData;
                    console.log('Local data loaded successfully');
                    return true;
                } catch (e) {
                    console.error('Error loading local data:', e);
                    initDefaultData();
                    return false;
                }
            } else {
                console.log('No local data found, using defaults');
                initDefaultData();
                return false;
            }
        }

        // Initialize with default data
        function initDefaultData() {
            appData = {
                units: [
                    { id: 1, name: 'DPC Carnes Frías', responsible: '', email: '', frequency: 'Semanal', status: 'Pendiente' },
                    { id: 2, name: 'Food Service', responsible: '', email: '', frequency: 'Diaria', status: 'Pendiente' },
                    { id: 3, name: 'Retail', responsible: '', email: '', frequency: 'Semanal', status: 'Pendiente' },
                    { id: 4, name: 'Exportación', responsible: '', email: '', frequency: 'Diaria', status: 'Pendiente' },
                    { id: 5, name: 'Agroindustrial', responsible: '', email: '', frequency: 'Semanal', status: 'Pendiente' }
                ],
                needs: {},
                research: {},
                metrics: {
                    decisions: 0,
                    opportunities: 0,
                    risks: 0,
                    time: 0
                },
                startDate: new Date().toISOString().split('T')[0],
                progress: 5
            };
            
            // Initialize needs and research for each unit
            appData.units.forEach(unit => {
                appData.needs[unit.id] = {
                    critical: '',
                    competitors: '',
                    regulations: '',
                    market: '',
                    technology: ''
                };
                
                appData.research[unit.id] = {
                    topics: []
                };
            });
            
            window.bafarHub.appData = appData;
        }

        // Update all UI elements
        function updateUI() {
            updateDashboard();
            updateUnitsTable();
            updateNeedsSection();
            updateResearchMatrix();
            updateMetrics();
        }

        // Update dashboard
        function updateDashboard() {
            const start = new Date(appData.startDate);
            const today = new Date();
            const diff = Math.floor((today - start) / (1000 * 60 * 60 * 24));
            const remaining = Math.max(0, 90 - diff);
            
            const daysEl = document.getElementById('daysRemaining');
            const startDateInputEl = document.getElementById('startDateInput');
            const unitsCountEl = document.getElementById('unitsCount');
            const progressEl = document.getElementById('progressPercent');
            const lastSyncEl = document.getElementById('lastSync');
            const currentModeEl = document.getElementById('currentMode');
            
            if (daysEl) daysEl.textContent = remaining;
            if (startDateInputEl) {
                startDateInputEl.value = appData.startDate;
                startDateInputEl.disabled = !window.bafarHub?.isEditor;
            }
            
            const totalUnits = appData.units.length;
            const activeUnits = appData.units.filter(u => u.responsible && u.responsible.trim() !== '').length;
            if (unitsCountEl) unitsCountEl.textContent = `${activeUnits}/${totalUnits}`;
            
            if (progressEl) progressEl.textContent = appData.progress + '%';
            
            // Update last sync time in multiple places
            const timeAgo = window.bafarHub?.lastSync ? window.bafarHub.getTimeAgo(window.bafarHub.lastSync) : 'Nunca';
            if (lastSyncEl) lastSyncEl.textContent = timeAgo;
            
            const lastSyncTimeEl = document.getElementById('lastSyncTime');
            if (lastSyncTimeEl && window.bafarHub?.lastSync) {
                lastSyncTimeEl.textContent = window.bafarHub.lastSync.toLocaleTimeString();
            }
            
            if (currentModeEl) currentModeEl.textContent = window.bafarHub?.isEditor ? 'Editor' : 'Lectura';
        }

        // Update start date
        function updateStartDate(newDate) {
            if (!window.bafarHub?.isEditor) return;
            
            appData.startDate = newDate;
            updateDashboard(); // Recalculate days remaining
            saveAllData();
            window.bafarHub.showNotification('Fecha de inicio actualizada', 'success');
        }

        // Update units table
        function updateUnitsTable() {
            const tbody = document.getElementById('unitsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.units.forEach((unit, index) => {
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" value="${unit.name}" onchange="updateUnitField(${index}, 'name', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td><input type="text" value="${unit.responsible || ''}" placeholder="Nombre" onchange="updateUnitField(${index}, 'responsible', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td><input type="email" value="${unit.email || ''}" placeholder="correo@bafar.com" onchange="updateUnitField(${index}, 'email', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td>
                        <select onchange="updateUnitField(${index}, 'frequency', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Diaria" ${unit.frequency === 'Diaria' ? 'selected' : ''}>Diaria</option>
                            <option value="Semanal" ${unit.frequency === 'Semanal' ? 'selected' : ''}>Semanal</option>
                            <option value="Quincenal" ${unit.frequency === 'Quincenal' ? 'selected' : ''}>Quincenal</option>
                            <option value="Mensual" ${unit.frequency === 'Mensual' ? 'selected' : ''}>Mensual</option>
                        </select>
                    </td>
                    <td>
                        <select onchange="updateUnitField(${index}, 'status', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Pendiente" ${unit.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="En Proceso" ${unit.status === 'En Proceso' ? 'selected' : ''}>En Proceso</option>
                            <option value="Activo" ${unit.status === 'Activo' ? 'selected' : ''}>Activo</option>
                        </select>
                    </td>
                    <td>
                        <button class="btn btn-danger btn-small" onclick="removeUnit(${index})" ${!window.bafarHub.isEditor ? 'disabled' : ''}>Eliminar</button>
                    </td>
                `;
            });
        }

        // Update needs section
        function updateNeedsSection() {
            const container = document.getElementById('needsContainer');
            const emptyMessage = document.getElementById('emptyNeedsMessage');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (appData.units.length === 0) {
                if (emptyMessage) emptyMessage.style.display = 'block';
                container.style.display = 'none';
                return;
            } else {
                if (emptyMessage) emptyMessage.style.display = 'none';
                container.style.display = 'grid';
            }
            
            appData.units.forEach(unit => {
                if (!appData.needs[unit.id]) {
                    appData.needs[unit.id] = {
                        critical: '',
                        competitors: '',
                        regulations: '',
                        market: '',
                        technology: ''
                    };
                }
                
                const needs = appData.needs[unit.id];
                const disabled = !window.bafarHub.isEditor;
                
                const unitDiv = document.createElement('div');
                unitDiv.className = 'unit-needs';
                unitDiv.innerHTML = `
                    <div class="unit-header">${unit.name}</div>
                    <div class="unit-body">
                        <div class="needs-section">
                            <h5>Información Crítica del Negocio</h5>
                            <textarea class="needs-input" placeholder="¿Qué información es vital para la operación diaria?" 
                                onchange="updateNeedField(${unit.id}, 'critical', this.value)" ${disabled ? 'disabled' : ''}>${needs.critical || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Monitoreo de Competencia</h5>
                            <textarea class="needs-input" placeholder="¿Qué necesitas saber sobre la competencia?" 
                                onchange="updateNeedField(${unit.id}, 'competitors', this.value)" ${disabled ? 'disabled' : ''}>${needs.competitors || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Regulaciones y Normatividad</h5>
                            <textarea class="needs-input" placeholder="¿Qué cambios regulatorios debes monitorear?" 
                                onchange="updateNeedField(${unit.id}, 'regulations', this.value)" ${disabled ? 'disabled' : ''}>${needs.regulations || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Tendencias de Mercado</h5>
                            <textarea class="needs-input" placeholder="¿Qué tendencias del mercado impactan tu negocio?" 
                                onchange="updateNeedField(${unit.id}, 'market', this.value)" ${disabled ? 'disabled' : ''}>${needs.market || ''}</textarea>
                        </div>
                        <div class="needs-section">
                            <h5>Innovación y Tecnología</h5>
                            <textarea class="needs-input" placeholder="¿Qué avances tecnológicos debes seguir?" 
                                onchange="updateNeedField(${unit.id}, 'technology', this.value)" ${disabled ? 'disabled' : ''}>${needs.technology || ''}</textarea>
                        </div>
                    </div>
                `;
                container.appendChild(unitDiv);
            });
        }

        // Update research matrix
        function updateResearchMatrix() {
            const container = document.getElementById('researchMatrixContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!appData.research) {
                appData.research = {};
            }
            
            if (appData.units.length === 0) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                        <p style="color: #6c757d; font-size: 16px;">No hay unidades de negocio configuradas.</p>
                        <p style="color: #6c757d;">Agregue unidades en la pestaña "Unidades de Negocio".</p>
                    </div>
                `;
                return;
            }
            
            appData.units.forEach(unit => {
                if (!appData.research[unit.id]) {
                    appData.research[unit.id] = { topics: [] };
                }
                
                const research = appData.research[unit.id];
                const topicsCount = research.topics.length;
                
                const unitCard = document.createElement('div');
                unitCard.className = 'unit-research-card';
                unitCard.innerHTML = `
                    <div class="unit-research-header">
                        <h3>${unit.name}</h3>
                        <div class="unit-info">
                            <span>Responsable: ${unit.responsible || 'No asignado'}</span>
                            <span>Tópicos: ${topicsCount}</span>
                            <span>Estado: ${unit.status}</span>
                        </div>
                    </div>
                    <div class="unit-research-body">
                        <div class="unit-summary">
                            <div class="summary-item">
                                <div class="summary-label">Total Tópicos</div>
                                <div class="summary-value">${topicsCount}</div>
                            </div>
                        </div>
                        
                        <h4>Tópicos de Investigación</h4>
                        <table class="research-topics-table">
                            <thead>
                                <tr>
                                    <th>Tópico</th>
                                    <th>Frecuencia</th>
                                    <th>Próxima Fecha</th>
                                    <th>Responsable</th>
                                    <th>Prioridad</th>
                                    ${window.bafarHub.isEditor ? '<th>Acciones</th>' : ''}
                                </tr>
                            </thead>
                            <tbody id="topics-table-${unit.id}">
                                ${generateTopicsRows(unit.id, research.topics)}
                            </tbody>
                        </table>
                        ${window.bafarHub.isEditor ? `<button class="add-topic-btn" onclick="addResearchTopic(${unit.id})">+ Agregar Tópico</button>` : ''}
                    </div>
                `;
                container.appendChild(unitCard);
            });
        }

        // Generate topic rows for research matrix
        function generateTopicsRows(unitId, topics) {
            if (!topics || topics.length === 0) {
                return '<tr><td colspan="6" style="text-align: center; color: #6c757d;">No hay tópicos configurados</td></tr>';
            }
            
            return topics.map((topic, index) => `
                <tr>
                    <td><input type="text" value="${topic.topic || ''}" onchange="updateResearchTopic(${unitId}, ${index}, 'topic', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td>
                        <select onchange="updateResearchTopic(${unitId}, ${index}, 'frequency', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Diaria" ${topic.frequency === 'Diaria' ? 'selected' : ''}>Diaria</option>
                            <option value="Semanal" ${topic.frequency === 'Semanal' ? 'selected' : ''}>Semanal</option>
                            <option value="Quincenal" ${topic.frequency === 'Quincenal' ? 'selected' : ''}>Quincenal</option>
                            <option value="Mensual" ${topic.frequency === 'Mensual' ? 'selected' : ''}>Mensual</option>
                            <option value="Trimestral" ${topic.frequency === 'Trimestral' ? 'selected' : ''}>Trimestral</option>
                        </select>
                    </td>
                    <td><input type="date" value="${topic.nextDate || ''}" onchange="updateResearchTopic(${unitId}, ${index}, 'nextDate', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td><input type="text" value="${topic.responsible || ''}" onchange="updateResearchTopic(${unitId}, ${index}, 'responsible', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}></td>
                    <td>
                        <select onchange="updateResearchTopic(${unitId}, ${index}, 'priority', this.value)" ${!window.bafarHub.isEditor ? 'disabled' : ''}>
                            <option value="Alta" ${topic.priority === 'Alta' ? 'selected' : ''}>Alta</option>
                            <option value="Media" ${topic.priority === 'Media' ? 'selected' : ''}>Media</option>
                            <option value="Baja" ${topic.priority === 'Baja' ? 'selected' : ''}>Baja</option>
                        </select>
                    </td>
                    ${window.bafarHub.isEditor ? `<td><button class="remove-topic-btn" onclick="removeResearchTopic(${unitId}, ${index})">Eliminar</button></td>` : ''}
                </tr>
            `).join('');
        }

        // Update metrics
        function updateMetrics() {
            const decisionsEl = document.getElementById('metricDecisions');
            const opportunitiesEl = document.getElementById('metricOpportunities');
            const risksEl = document.getElementById('metricRisks');
            const timeEl = document.getElementById('metricTime');
            
            if (decisionsEl) {
                decisionsEl.value = appData.metrics.decisions || 0;
                decisionsEl.disabled = !window.bafarHub.isEditor;
            }
            if (opportunitiesEl) {
                opportunitiesEl.value = appData.metrics.opportunities || 0;
                opportunitiesEl.disabled = !window.bafarHub.isEditor;
            }
            if (risksEl) {
                risksEl.value = appData.metrics.risks || 0;
                risksEl.disabled = !window.bafarHub.isEditor;
            }
            if (timeEl) {
                timeEl.value = appData.metrics.time || 0;
                timeEl.disabled = !window.bafarHub.isEditor;
            }
        }

        // Event handlers
        function updateUnitField(index, field, value) {
            if (appData.units[index]) {
                appData.units[index][field] = value;
                if (field === 'name') {
                    updateNeedsSection();
                    updateResearchMatrix();
                }
                if (field === 'responsible') {
                    updateDashboard();
                    updateResearchMatrix();
                }
                saveAllData();
            }
        }

        function updateNeedField(unitId, field, value) {
            if (!appData.needs[unitId]) {
                appData.needs[unitId] = {};
            }
            appData.needs[unitId][field] = value;
            saveAllData();
        }

        function addUnitFromForm() {
            if (!window.bafarHub.isEditor) return;
            
            const input = document.getElementById('newUnitName');
            const name = input ? input.value.trim() : '';
            
            if (!name) {
                window.bafarHub.showNotification('Por favor ingrese un nombre para la unidad', 'warning');
                return;
            }
            
            let newId = 1;
            if (appData.units.length > 0) {
                const maxId = Math.max(...appData.units.map(u => u.id || 0));
                newId = maxId + 1;
            }
            
            const newUnit = {
                id: newId,
                name: name,
                responsible: '',
                email: '',
                frequency: 'Semanal',
                status: 'Pendiente'
            };
            
            appData.units.push(newUnit);
            
            appData.needs[newId] = {
                critical: '',
                competitors: '',
                regulations: '',
                market: '',
                technology: ''
            };
            
            appData.research[newId] = {
                topics: []
            };
            
            input.value = '';
            updateUI();
            saveAllData();
            
            window.bafarHub.showNotification('Unidad agregada: ' + name, 'success');
        }

        function removeUnit(index) {
            if (!window.bafarHub.isEditor) return;
            if (!appData.units[index]) return;
            
            const unitName = appData.units[index].name;
            
            if (confirm('¿Está seguro de eliminar esta unidad: ' + unitName + '?')) {
                const unitId = appData.units[index].id;
                
                appData.units.splice(index, 1);
                
                if (appData.needs[unitId]) {
                    delete appData.needs[unitId];
                }
                
                if (appData.research[unitId]) {
                    delete appData.research[unitId];
                }
                
                updateUI();
                saveAllData();
                
                window.bafarHub.showNotification('Unidad eliminada: ' + unitName, 'success');
            }
        }

        function addResearchTopic(unitId) {
            if (!window.bafarHub.isEditor) return;
            
            if (!appData.research[unitId]) {
                appData.research[unitId] = { topics: [] };
            }
            
            const newTopic = {
                topic: '',
                frequency: 'Semanal',
                nextDate: '',
                responsible: '',
                priority: 'Media'
            };
            
            appData.research[unitId].topics.push(newTopic);
            updateResearchMatrix();
            saveAllData();
        }

        function updateResearchTopic(unitId, topicIndex, field, value) {
            if (appData.research[unitId] && appData.research[unitId].topics[topicIndex]) {
                appData.research[unitId].topics[topicIndex][field] = value;
                saveAllData();
            }
        }

        function removeResearchTopic(unitId, topicIndex) {
            if (!window.bafarHub.isEditor) return;
            
            if (confirm('¿Eliminar este tópico de investigación?')) {
                if (appData.research[unitId] && appData.research[unitId].topics) {
                    appData.research[unitId].topics.splice(topicIndex, 1);
                    updateResearchMatrix();
                    saveAllData();
                }
            }
        }

        function saveAllData() {
            // Update metrics from inputs
            const decisionsEl = document.getElementById('metricDecisions');
            const opportunitiesEl = document.getElementById('metricOpportunities');
            const risksEl = document.getElementById('metricRisks');
            const timeEl = document.getElementById('metricTime');
            
            if (decisionsEl) appData.metrics.decisions = parseInt(decisionsEl.value) || 0;
            if (opportunitiesEl) appData.metrics.opportunities = parseInt(opportunitiesEl.value) || 0;
            if (risksEl) appData.metrics.risks = parseInt(risksEl.value) || 0;
            if (timeEl) appData.metrics.time = parseInt(timeEl.value) || 0;
            
            // Update metadata
            appData.lastUpdate = new Date().toISOString();
            appData.lastEditor = window.bafarHub.user?.username || 'Usuario';
            
            // Update hub data
            window.bafarHub.appData = appData;
            
            // Save locally only (no GitHub modal for every change)
            window.bafarHub.saveToLocal();
            
            // Show subtle notification
            window.bafarHub.showNotification('Cambios guardados localmente', 'success', 1500);
        }
        
        // GitHub auto-sync instance
        let gitHubAutoSync = null;
        
        // Manual save to GitHub (for explicit saves)
        async function saveToGitHub() {
            if (!window.bafarHub.isEditor) {
                window.bafarHub.showNotification('Solo los editores pueden guardar cambios', 'warning');
                return;
            }
            
            // Initialize GitHub auto-sync if not done
            if (!gitHubAutoSync) {
                gitHubAutoSync = new GitHubAutoSync();
            }
            
            const saveBtn = document.getElementById('saveGitHubBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '🔄 Guardando en GitHub...';
            }
            
            try {
                // Update metadata
                appData.lastUpdate = new Date().toISOString();
                appData.lastEditor = window.bafarHub.user ? window.bafarHub.user.username : 'Usuario';
                
                // Auto-commit to GitHub
                const result = await gitHubAutoSync.saveToGitHub(appData);
                
                if (result.success) {
                    showSaveIndicator();
                    document.getElementById('syncStatusText').textContent = `✅ Guardado en GitHub - ${new Date().toLocaleTimeString()}`;
                    
                    // Also save locally as backup
                    window.bafarHub.appData = appData;
                    window.bafarHub.saveToLocal();
                    
                    // Show success notification
                    showNotification('✅ Cambios guardados en GitHub automáticamente', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Error saving to GitHub:', error);
                
                if (error.message.includes('token') || error.message.includes('GITHUB_TOKEN_AQUI')) {
                    showGitHubTokenDialog();
                } else {
                    alert(`Error al guardar en GitHub: ${error.message}\\n\\nGuardando localmente como respaldo.`);
                    // Fallback to local save
                    window.bafarHub.appData = appData;
                    window.bafarHub.saveToLocal();
                }
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '💾 Sincronizar Cambios';
                }
            }
        }
        
        // Show GitHub token setup dialog
        function showGitHubTokenDialog() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3>🔑 Configurar GitHub Token</h3>
                    <p>Para guardar automáticamente en GitHub, necesitas configurar un token:</p>
                    
                    <ol style="text-align: left; margin: 20px 0;">
                        <li>Ve a <a href="https://github.com/settings/tokens" target="_blank">GitHub → Settings → Developer settings → Personal access tokens</a></li>
                        <li>Click "Generate new token (classic)"</li>
                        <li>Nombre: "BAFAR Intelligence Hub"</li>
                        <li>Selecciona: <strong>repo</strong> (Full control)</li>
                        <li>Click "Generate token"</li>
                        <li>Copia el token (empieza con ghp_)</li>
                    </ol>
                    
                    <div style="margin: 20px 0;">
                        <label>Pega tu GitHub Token aquí:</label><br>
                        <input type="password" id="githubTokenInput" placeholder="ghp_xxxxxxxxxxxxxxxx" style="width: 100%; padding: 10px; margin: 5px 0;">
                        <small style="color: #666;">El token se guardará localmente en tu navegador</small>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="saveGitHubToken()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                            💾 Guardar Token
                        </button>
                        <button onclick="closeGitHubTokenDialog()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                            Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.githubTokenModal = modal;
        }
        
        // Save GitHub token
        function saveGitHubToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) {
                alert('Por favor ingresa un token válido');
                return;
            }
            
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('El token debe empezar con "ghp_" o "github_pat_"');
                return;
            }
            
            // Save token locally
            localStorage.setItem('github_token', token);
            
            // Update auto-sync instance
            if (gitHubAutoSync) {
                gitHubAutoSync.setToken(token);
            }
            
            closeGitHubTokenDialog();
            alert('✅ Token guardado correctamente. Ahora puedes guardar en GitHub automáticamente.');
        }
        
        // Close token dialog
        function closeGitHubTokenDialog() {
            if (window.githubTokenModal) {
                document.body.removeChild(window.githubTokenModal);
                window.githubTokenModal = null;
            }
        }

        // Función unificada para actualizar datos
        function refreshData() {
            document.getElementById('syncStatusText').textContent = '🔄 Actualizando desde GitHub...';
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('refreshBtn').textContent = '🔄 Actualizando...';
            
            window.bafarHub.loadFromGitHub().then(success => {
                if (success) {
                    appData = window.bafarHub.appData;
                    updateUI();
                    const now = new Date();
                    window.bafarHub.lastSync = now;
                    document.getElementById('syncStatusText').textContent = '✅ Conectado a GitHub - Datos actualizados';
                    document.getElementById('lastSyncTime').textContent = now.toLocaleTimeString();
                    window.bafarHub.showNotification('Datos actualizados desde GitHub', 'success');
                } else {
                    document.getElementById('syncStatusText').textContent = '⚠️ Sin conexión - Usando datos locales';
                    window.bafarHub.showNotification('No se pudo conectar a GitHub', 'warning');
                }
                
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('refreshBtn').textContent = '🔄 Actualizar Datos';
            });
        }

        // Funciones simplificadas - solo las necesarias
        function exportDataFile() {
            window.bafarHub.exportData();
        }

        function exportData(type) {
            window.bafarHub.exportData(type);
        }

        function generateResearchReport() {
            window.bafarHub.showNotification('Funcionalidad en desarrollo', 'info');
        }

        function generateMetricsReport() {
            window.bafarHub.showNotification('Funcionalidad en desarrollo', 'info');
        }

        function updateTimelineProgress() {
            window.bafarHub.showNotification('Funcionalidad en desarrollo', 'info');
        }

        function fixDataStructure() {
            window.bafarHub.showNotification('Estructura verificada', 'success');
        }

        function resetAllData() {
            if (!window.bafarHub.isEditor) return;
            
            if (confirm('¿Está seguro de reiniciar todos los datos? Esta acción no se puede deshacer.')) {
                localStorage.removeItem('bafarHub');
                initDefaultData();
                updateUI();
                saveAllData();
                window.bafarHub.showNotification('Datos reiniciados correctamente', 'success');
            }
        }

        function showSection(sectionId, button) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
            }
            
            if (button) {
                document.querySelectorAll('.nav button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
            }
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Auto-save every 60 seconds
        setInterval(saveAllData, 60000);
    </script>
</body>
</html>